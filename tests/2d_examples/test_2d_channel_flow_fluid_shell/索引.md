# 📂 test_2d_channel_flow_fluid_shell 功能-代码映射报告

## 🏗️ 项目概览
- **技术栈**: C++11/14, SPHinXsys (光滑粒子流体动力学库), Google Test
- **架构模式**: 过程化/基于模块 (定义物理体、材料、粒子生成器、数值算法和数据IO)
- **状态管理**: SPHinXsys 内部粒子数据结构
- **样式方案**: N/A (C++科学计算代码)
- **构建工具**: `build.bat` (推测为Windows批处理脚本)
- **包管理**: N/A (使用系统或外部库链接)

## 📊 功能模块统计
- **主模拟文件**: 1 个 ([`channel_flow_shell.cpp`](channel_flow_shell.cpp:1))
- **几何定义类**: 1 个 ([`WaterBlock`](channel_flow_shell.cpp:28))
- **粒子生成器**: 1 个 ([`ParticleGenerator<SurfaceParticles, WallBoundary>`](channel_flow_shell.cpp:41))
- **边界条件结构体**: 1 个 ([`InflowVelocity`](channel_flow_shell.cpp:77))
- **GTest测试**: 1 个 ([`TEST(channel_flow_shell, thickness_10x)`](channel_flow_shell.cpp:365))

## 🗂️ 目录结构概览
```
[项目根目录]/
├── channel_flow_shell.cpp  <- 主模拟逻辑
├── build.bat               <- 构建脚本
├── visualize_velocity_field.m <- MATLAB可视化脚本
├── input/                  <- 潜在的输入文件目录
├── output/                 <- 模拟结果输出目录
└── output_backup/          <- 历史模拟结果
```

---

## 🎯 功能映射表

### 配置 - 全局物理参数 (流体特性)

**🔤 用户描述方式**:
- 主要: "流体密度", "粘度", "雷诺数", "声速", "特征速度"
- 别名: "物理常数", "流体属性", "模拟输入参数"

**📍 代码位置**:
- 主文件: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:18) (定义 `rho0_f`, `U_f`, `c_f`, `Re`, `mu_f`)
- 逻辑: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:169) (在 `water_block` 上定义材料属性)

**🎨 视觉标识**:
- 外观: N/A (后台配置)
- 文本: N/A

**⚡ 修改指引**:
- 修改流体密度: 编辑 [`channel_flow_shell.cpp:18`](channel_flow_shell.cpp:18) (`rho0_f`)
- 修改雷诺数: 编辑 [`channel_flow_shell.cpp:21`](channel_flow_shell.cpp:21) (`Re`)
- 修改粘性系数: 编辑 [`channel_flow_shell.cpp:22`](channel_flow_shell.cpp:22) (`mu_f`)

---

### 几何 - 模拟区域尺寸和流体形状

**🔤 用户描述方式**:
- 主要: "通道长度", "通道高度", "模拟区域大小", "流体区域形状"
- 别名: "DL", "DH", "几何参数", "计算域"

**📍 代码位置**:
- 尺寸定义: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:13) (定义 `DL`, `DH`)
- 形状创建: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:147) (Lambda函数 `createWaterBlockShape`)
- 域边界: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:142) (定义 `system_domain_bounds`)

**🎨 视觉标识**:
- 外观: N/A (后台配置)
- 文本: N/A

**⚡ 修改指引**:
- 修改通道长度/高度: 编辑 [`channel_flow_shell.cpp:13`](channel_flow_shell.cpp:13) 和 [`channel_flow_shell.cpp:14`](channel_flow_shell.cpp:14)
- 修改流体块的几何坐标: 编辑 [`channel_flow_shell.cpp:151-155`](channel_flow_shell.cpp:151)

---

### 边界条件 - 抛物线流入速度

**🔤 用户描述方式**:
- 主要: "入口速度条件", "抛物线流入", "InflowVelocity", "加速时间"
- 别名: "入口边界", "速度剖面"

**📍 代码位置**:
- 速度函数定义: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:89) (`operator()`)
- 边界条件应用: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:217) (定义 `inflow_buffer` 和 `parabolic_inflow`)
- 加速时间: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:85) (`t_ref_ = 2.0`)

**🎨 视觉标识**:
- 外观: N/A (后台算法)
- 文本: N/A

**⚡ 修改指引**:
- 修改流入速度配置文件: 编辑 [`channel_flow_shell.cpp`](channel_flow_shell.cpp:77) 中的 `InflowVelocity` 结构体
- 修改速度曲线逻辑: 编辑 [`channel_flow_shell.cpp:92`](channel_flow_shell.cpp:92)

---

### 边界条件 - 周期性边界

**🔤 用户描述方式**:
- 主要: "周期性边界条件", "X方向周期性", "PeriodicCondition"
- 别名: "循环边界", "周期条件"

**📍 代码位置**:
- 周期轴定义: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:221) (`PeriodicAlongAxis periodic_along_x`)
- 周期条件对象: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:222) (`PeriodicConditionUsingCellLinkedList periodic_condition`)

**⚡ 修改指引**:
- 禁用或修改周期轴: 编辑 [`channel_flow_shell.cpp:221`](channel_flow_shell.cpp:221)

---

### 数据输出 - VTP文件状态记录

**🔤 用户描述方式**:
- 主要: "VTP文件输出", "体状态记录", "输出流体形状", "壁面曲率输出"
- 别名: "可视化数据", "Paraview文件"

**📍 代码位置**:
- VTP记录器: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:232) (`BodyStatesRecordingToVtp write_real_body_states`)
- 输出变量添加: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:233) (添加 `Average1stPrincipleCurvature`)
- 输出执行: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:267), [`channel_flow_shell.cpp:322`](channel_flow_shell.cpp:322)

**⚡ 修改指引**:
- 调整输出频率: 修改 [`channel_flow_shell.cpp:258`](channel_flow_shell.cpp:258) (`output_interval`)
- 更改输出路径: 需要修改 SPHinXsys 库的配置或在主函数中添加路径参数（当前代码中未暴露）
- 增加要记录的变量: 在 [`channel_flow_shell.cpp:233`](channel_flow_shell.cpp:233) 附近添加新的 `addToWrite` 调用

---

### 数据输出 - 观察点速度记录

**🔤 用户描述方式**:
- 主要: "观察点速度", "数据观测", "CSV输出", "FluidAxialObserver"
- 别名: "轴向速度曲线", "径向速度曲线", "数据探针"

**📍 代码位置**:
- 轴向观察点定义: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:101) (`createFluidAxialObservationPoints`)
- 径向观察点定义: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:118) (`createFluidRadialObservationPoints`)
- 记录器: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:234) (`ObservedQuantityRecording`)
- 输出执行: [`channel_flow_shell.cpp:325`](channel_flow_shell.cpp:325) 和 [`channel_flow_shell.cpp:326`](channel_flow_shell.cpp:326)

**⚡ 修改指引**:
- 修改轴向观察点位置: 编辑 [`channel_flow_shell.cpp:108`](channel_flow_shell.cpp:108) (`y_position`) 或 [`channel_flow_shell.cpp:106`](channel_flow_shell.cpp:106) (`range_of_measure`)
- 修改径向观察点位置: 编辑 [`channel_flow_shell.cpp:125`](channel_flow_shell.cpp:125) (`x_position`)
- 调整输出频率: 与 VTP 文件输出频率一致，修改 [`channel_flow_shell.cpp:258`](channel_flow_shell.cpp:258) (`output_interval`)

---

### 模拟执行 - 时间步长和主循环

**🔤 用户描述方式**:
- 主要: "模拟运行时间", "时间步长计算", "主循环", "迭代次数"
- 别名: "End Time", "Simulation Loop", "时间积分"

**📍 代码位置**:
- 结束时间: [`channel_flow_shell.cpp:257`](channel_flow_shell.cpp:257) (`end_time = 10.0`)
- 主循环: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:271) (`while (physical_time < end_time)`)
- 时间步长计算: [`channel_flow_shell.cpp:277`](channel_flow_shell.cpp:277) (`get_fluid_advection_time_step_size.exec()`)

**⚡ 修改指引**:
- 延长或缩短模拟时间: 编辑 [`channel_flow_shell.cpp:257`](channel_flow_shell.cpp:257)
- 调整屏幕输出频率: 编辑 [`channel_flow_shell.cpp:256`](channel_flow_shell.cpp:256) (`screen_output_interval`)

---

### 编译和测试 - GTest执行

**🔤 用户描述方式**:
- 主要: "GTest测试", "运行测试", "CI测试", "结果验证"
- 别名: "单元测试", "EXPECT_NEAR", "验证逻辑"

**📍 代码位置**:
- 测试定义: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:365) (`TEST(channel_flow_shell, thickness_10x)`)
- 测试逻辑: [`channel_flow_shell.cpp:340-362`](channel_flow_shell.cpp:340) (将模拟结果与解析解进行比较)
- 主函数: [`channel_flow_shell.cpp`](channel_flow_shell.cpp:375) (调用 `RUN_ALL_TESTS()`)

**⚡ 修改指引**:
- 修改测试精度: 编辑 [`channel_flow_shell.cpp:353`](channel_flow_shell.cpp:353) 和 [`channel_flow_shell.cpp:361`](channel_flow_shell.cpp:361) 中的容差值 (`U_f * 5e-2`)
- 添加新的测试用例: 在 [`channel_flow_shell.cpp:365`](channel_flow_shell.cpp:365) 附近添加新的 `TEST` 块

---

## 📚 深度技术文档

### Verlet时间积分方案

**相关文档**:
- [`Verlet时间积分与密度更新详解.md`](Verlet时间积分与密度更新详解.md) - 完整的时间积分方案解析
- [`前后半步对比详解.md`](前后半步对比详解.md) - Integration1stHalf vs Integration2ndHalf详细对比

**核心代码位置**（SPHinXsys源码）:
- Integration1stHalf: `src/shared/particle_dynamics/fluid_dynamics/fluid_integration.hpp:64-80`
- Integration2ndHalf: `src/shared/particle_dynamics/fluid_dynamics/fluid_integration.hpp:179-196`
- 黎曼求解器: `src/shared/physical_closure/materials/riemann_solver.h:92-99`

**在Channel Flow中的使用**:
```cpp
// channel_flow_shell.cpp:195-196
Dynamics1Level<fluid_dynamics::Integration1stHalfWithWallRiemann>
    pressure_relaxation(water_block_inner, water_block_contact);

Dynamics1Level<fluid_dynamics::Integration2ndHalfWithWallNoRiemann>
    density_relaxation(water_block_inner, water_block_contact);
```

**关键技术点**:
1. **前半步（1st Half）**:
   - 更新速度：`v^(n+1/2) = v^n + F/m × dt`
   - 更新密度（黎曼耗散）：`drho_dt_ = ρ Σ [(p_i - p_j)/(ρ₀c₀)] ∇W V`
   - 源码位置：`fluid_integration.hpp:78-79`

2. **后半步（2nd Half）**:
   - 更新密度（连续性方程）：`drho_dt_ += ρ Σ (v_i - v_j)·e_ij ∇W V`
   - 传输速度修正：`force = Σ [ρ₀c₀ u_jump] ∇W V e_ij`（NoRiemann版本此项为0）
   - 源码位置：`fluid_integration.hpp:191-195`

3. **完整密度演化**:
   ```
   ρ^(n+1) = ρ^n + [黎曼耗散项] × dt/2    (前半步)
                 + [连续性方程项] × dt/2   (后半步)
   ```

**修改指引**:
- 切换为NoRiemann: 将 `Integration1stHalfWithWallRiemann` 改为 `Integration1stHalfWithWallNoRiemann`
- 启用2nd Half黎曼: 将 `Integration2ndHalfWithWallNoRiemann` 改为 `Integration2ndHalfWithWallRiemann`

**注意事项**:
- NoRiemann **不意味着无密度更新**，连续性方程仍然存在
- 2nd Half的密度更新是**累加**到1st Half的结果上（使用`+=`）
- 低速流动（如本例Re=100）使用1st Half Riemann + 2nd Half NoRiemann是稳定性和效率的平衡