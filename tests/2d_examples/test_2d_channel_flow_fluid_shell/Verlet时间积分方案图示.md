# Verlet时间积分方案图示说明

## 完整时间步流程图

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    时刻 t^n 的状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  状态量: v^n (速度), ρ^n (密度), x^n (位置)
  辅助量: p^n = EOS(ρ^n) (压力), drho_dt_^n (密度变化率)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

                              ↓

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Integration1stHalf (前半步) - 压力松弛阶段                               ┃
┃ 类: Integration1stHalf<Inner<>, RiemannSolverType, KernelCorrectionType>┃
┃ 源码: fluid_integration.hpp:50-80                                       ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

  ┌────────────────────────────────────────────────────────────────────┐
  │ 1. initialization (Line 50-55)                                     │
  │                                                                    │
  │    ρ^(n+1/2) = ρ^n + drho_dt_^n × dt/2   [使用上一步的黎曼耗散]      │
  │    p^(n+1/2) = EOS(ρ^(n+1/2))            [状态方程更新压力]         │
  │    x^(n+1/2) = x^n + v^n × dt/2          [位置半步预测]             │
  └────────────────────────────────────────────────────────────────────┘
                              ↓
  ┌────────────────────────────────────────────────────────────────────┐
  │ 2. interaction (Line 64-80) ← 用户高亮的代码在这里！                 │
  │                                                                    │
  │    对每个邻居粒子j:                                                 │
  │      ┌─ 动量方程 ────────────────────────────────────────────┐   │
  │      │ force -= (p_i + p_j) ∇W_ij V_j e_ij                  │   │
  │      │ [压力梯度力，基于压力p]                                │   │
  │      └───────────────────────────────────────────────────────┘   │
  │      ┌─ 密度松弛（黎曼耗散）─────────────────────────────────┐   │
  │      │ rho_dissipation += DissipativeUJump(p_i - p_j) ∇W V  │   │
  │      │                  = (p_i - p_j)/(ρ₀c₀) × ∇W_ij V_j    │   │
  │      │ [基于压力差的密度松弛，模拟声波传播]                   │   │
  │      └───────────────────────────────────────────────────────┘   │
  │                                                                    │
  │    force_[i] += force × V_i              [累加压力梯度力]           │
  │    drho_dt_[i] = rho_dissipation × ρ^(n+1/2)  [替换操作 =]         │
  │                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^        │
  │                  这就是用户高亮的Line 896-897！                      │
  └────────────────────────────────────────────────────────────────────┘
                              ↓
  ┌────────────────────────────────────────────────────────────────────┐
  │ 3. update (Line 58-61)                                             │
  │                                                                    │
  │    v^(n+1/2) = v^n + (F_prior + force)/m × dt  [速度全步更新]      │
  └────────────────────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  前半步输出状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  v^(n+1/2), ρ^(n+1/2), x^(n+1/2), drho_dt_^(n+1) [黎曼耗散项]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

                              ↓

┌──────────────────────────────────────────────────────────────────────┐
│ constant_gravity.exec(dt)  [施加重力等外力]                            │
│ v^(n+1/2) += g × dt                                                  │
└──────────────────────────────────────────────────────────────────────┘

                              ↓

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Integration2ndHalf (后半步) - 密度松弛阶段                               ┃
┃ 类: Integration2ndHalf<Inner<>, RiemannSolverType>                     ┃
┃ 源码: fluid_integration.hpp:167-196                                    ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

  ┌────────────────────────────────────────────────────────────────────┐
  │ 1. initialization (Line 167-170)                                   │
  │                                                                    │
  │    x^(n+1) = x^(n+1/2) + v^(n+1/2) × dt/2  [完成位置的另外半步]     │
  └────────────────────────────────────────────────────────────────────┘
                              ↓
  ┌────────────────────────────────────────────────────────────────────┐
  │ 2. interaction (Line 179-196)                                      │
  │                                                                    │
  │    对每个邻居粒子j:                                                 │
  │      ┌─ 连续性方程 ──────────────────────────────────────────┐   │
  │      │ u_jump = (v_i - v_j)·e_ij                             │   │
  │      │ density_change_rate += u_jump × ∇W_ij V_j             │   │
  │      │ [基于速度散度的密度变化，质量守恒]                      │   │
  │      └───────────────────────────────────────────────────────┘   │
  │      ┌─ 传输速度修正（人工粘性）───────────────────────────────┐   │
  │      │ p_dissipation += DissipativePJump(u_jump) ∇W V e_ij  │   │
  │      │                = ρ₀c₀ u_jump × ∇W_ij V_j e_ij         │   │
  │      │ [速度差产生的人工粘性力，XSPH技术]                      │   │
  │      │ (NoRiemann版本此项为0)                                 │   │
  │      └───────────────────────────────────────────────────────┘   │
  │                                                                    │
  │    drho_dt_[i] += density_change_rate × ρ^(n+1/2)  [累加操作 +=]   │
  │                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^             │
  │                   注意：这里是累加到1st Half的黎曼耗散上！           │
  │                                                                    │
  │    force_[i] = p_dissipation × V_i  [替换为传输速度修正力]          │
  └────────────────────────────────────────────────────────────────────┘
                              ↓
  ┌────────────────────────────────────────────────────────────────────┐
  │ 3. update (Line 173-176)                                           │
  │                                                                    │
  │    ρ^(n+1) = ρ^(n+1/2) + drho_dt_^(n+1) × dt/2                    │
  │            = ρ^(n+1/2) + [黎曼耗散项 + 连续性方程项] × dt/2         │
  │              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^            │
  │              这里的drho_dt_包含两部分！                             │
  └────────────────────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    时刻 t^(n+1) 的状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  状态量: v^(n+1/2) (半步速度), ρ^(n+1) (密度), x^(n+1) (位置)
  辅助量: p^(n+1) = EOS(ρ^(n+1)), drho_dt_^(n+1) (密度变化率)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 密度变化率的两次操作详解

### 第一次：前半步（替换操作）

```cpp
// fluid_integration.hpp:78-79
force_[index_i] += force * Vol_[index_i];
drho_dt_[index_i] = rho_dissipation * rho_[index_i];  // ← 使用 = （替换）
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                    这是黎曼耗散项，基于压力差
```

**数学表达式**：
```
drho_dt_^(n+1) = Σ_j [(p_i - p_j)/(ρ₀c₀)] ∇W_ij V_j × ρ^(n+1/2)
```

**物理意义**：
- 高压区向低压区"释放"质量
- 通过声波传播实现的压力-密度耦合
- 稳定压力场，防止数值振荡

---

### 第二次：后半步（累加操作）

```cpp
// fluid_integration.hpp:194
drho_dt_[index_i] += density_change_rate * rho_[index_i];  // ← 使用 += （累加）
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                     这是连续性方程项，基于速度散度
```

**数学表达式**：
```
drho_dt_^(n+1) = [黎曼耗散项] + Σ_j (v_i - v_j)·e_ij ∇W_ij V_j × ρ^(n+1/2)
                 ^^^^^^^^^^^^   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                 1st Half设置   2nd Half累加
```

**物理意义**：
- 速度散度导致的密度变化
- 质量守恒（连续性方程）
- 纯运动学过程，不涉及压力

---

## 完整密度演化公式

### 从 t^n 到 t^(n+1) 的完整过程

```
ρ^(n+1) = ρ^n
        + [drho_dt_^n] × dt/2                    ← 前半步initialization
        + [drho_dt_^(n+1)] × dt/2                ← 后半步update

其中：
drho_dt_^(n+1) = [黎曼耗散项] + [连续性方程项]
               = Σ_j [(p_i - p_j)/(ρ₀c₀)] ∇W V × ρ^(n+1/2)  [1st Half]
               + Σ_j (v_i - v_j)·e_ij ∇W V × ρ^(n+1/2)      [2nd Half]
```

**展开完整公式**：
```
ρ^(n+1) = ρ^n
        + dt/2 × Σ_j [(p_i^n - p_j^n)/(ρ₀c₀)] ∇W V × ρ^n        [前半步init]
        + dt/2 × Σ_j [(p_i^(n+1/2) - p_j^(n+1/2))/(ρ₀c₀)] ∇W V × ρ^(n+1/2)  [1st Half]
        + dt/2 × Σ_j (v_i^(n+1/2) - v_j^(n+1/2))·e_ij ∇W V × ρ^(n+1/2)      [2nd Half]
```

---

## 黎曼求解器函数对比图

### DissipativeUJump（1st Half使用）

```
┌─────────────────────────────────────────────────────────────────┐
│ 函数签名：Real DissipativeUJump(const Real &p_jump)            │
│ 源码位置：riemann_solver.h:96-99                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入：压力跳跃                                                  │
│  ┌─────────────┐                                               │
│  │ Δp = p_i - p_j  [Pa]                                        │
│  └──────┬──────┘                                               │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────────────────────────────┐                      │
│  │ 黎曼不变量转换:                        │                      │
│  │ Δu/(ρ₀c₀) = Δp × inv_rho0c0_ave_     │                      │
│  │            = Δp × 2/(ρ₀c₀_i + ρ₀c₀_j) │                      │
│  └──────┬───────────────────────────────┘                      │
│         │                                                       │
│         ▼                                                       │
│  输出：等效速度散度                                              │
│  ┌─────────────┐                                               │
│  │ Δu/(ρ₀c₀)  [1/s]                                           │
│  └─────────────┘                                               │
│                                                                 │
│  物理意义：压力扰动 → 速度变化（通过声波）                       │
│  典型应用：1st Half密度松弛                                     │
└─────────────────────────────────────────────────────────────────┘
```

---

### DissipativePJump（2nd Half使用）

```
┌─────────────────────────────────────────────────────────────────┐
│ 函数签名：Real DissipativePJump(const Real &u_jump)            │
│ 源码位置：riemann_solver.h:92-95                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入：速度跳跃                                                  │
│  ┌─────────────┐                                               │
│  │ Δu = (v_i - v_j)·e_ij  [m/s]                               │
│  └──────┬──────┘                                               │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────────────────────────────────────┐              │
│  │ 限制器调制:                                    │              │
│  │ limited_mach = limiter_(SMAX(Δu, 0))          │              │
│  │ (TruncatedLinear限制器，防止过度耗散)           │              │
│  └──────┬───────────────────────────────────────┘              │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────────────────────────────────────┐              │
│  │ 人工粘性力:                                    │              │
│  │ F = ρ₀c₀_geo_ave × Δu × limited_mach         │              │
│  │   = 2(ρ₀c₀_i)(ρ₀c₀_j)/(ρ₀c₀_i+ρ₀c₀_j) × Δu   │              │
│  └──────┬───────────────────────────────────────┘              │
│         │                                                       │
│         ▼                                                       │
│  输出：等效压力力                                                │
│  ┌─────────────┐                                               │
│  │ ρ₀c₀ Δu  [N/m³]                                            │
│  └─────────────┘                                               │
│                                                                 │
│  物理意义：速度扰动 → 人工粘性力（传输速度修正，XSPH）            │
│  典型应用：2nd Half传输速度修正                                 │
│  NoRiemann版本：返回0（无传输速度修正）                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## NoRiemann vs Riemann对比

### 前半步（1st Half）

```
┌─────────────────────────────────────────────────────────────────┐
│ Integration1stHalfWithWallRiemann (当前使用)                    │
├─────────────────────────────────────────────────────────────────┤
│ DissipativeUJump(p_jump) = p_jump × 2/(ρ₀c₀_i + ρ₀c₀_j)        │
│                                                                 │
│ drho_dt_[i] = Σ_j [(p_i - p_j)/(ρ₀c₀)] ∇W V × ρ               │
│               ^^^^^^^^^^^^^^^^^^^^^^^^                          │
│               黎曼耗散项 ≠ 0                                     │
│                                                                 │
│ 效果：压力场稳定，数值振荡小                                      │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ Integration1stHalfWithWallNoRiemann (替代方案)                  │
├─────────────────────────────────────────────────────────────────┤
│ DissipativeUJump(p_jump) = 0  (NoRiemannSolver返回0)           │
│                                                                 │
│ drho_dt_[i] = 0 × ρ = 0                                        │
│               ^^^^^^^^^                                         │
│               黎曼耗散项 = 0                                     │
│                                                                 │
│ 效果：压力振荡严重，可能导致发散（不适合本例）                     │
└─────────────────────────────────────────────────────────────────┘
```

---

### 后半步（2nd Half）

```
┌─────────────────────────────────────────────────────────────────┐
│ Integration2ndHalfWithWallRiemann (备选方案)                    │
├─────────────────────────────────────────────────────────────────┤
│ DissipativePJump(u_jump) = ρ₀c₀ × u_jump × limiter             │
│                                                                 │
│ drho_dt_[i] += Σ_j (v_i - v_j)·e_ij ∇W V × ρ  [连续性方程]     │
│ force_[i] = Σ_j [ρ₀c₀ u_jump] ∇W V e_ij       [传输速度修正]    │
│             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                       │
│             额外的人工粘性力 ≠ 0                                 │
│                                                                 │
│ 效果：更稳定，但计算量增加，低速流动不必要                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ Integration2ndHalfWithWallNoRiemann (当前使用)                  │
├─────────────────────────────────────────────────────────────────┤
│ DissipativePJump(u_jump) = 0  (NoRiemannSolver返回0)           │
│                                                                 │
│ drho_dt_[i] += Σ_j (v_i - v_j)·e_ij ∇W V × ρ  [连续性方程]     │
│ force_[i] = 0 × V_i = 0                        [无传输速度修正]  │
│                                                                 │
│ 注意：连续性方程仍然存在！密度仍然更新！                          │
│                                                                 │
│ 效果：效率高，对Re=100的低速流动足够稳定                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## Channel Flow实际执行流程

### 主循环中的调用（channel_flow_shell.cpp:281-295）

```cpp
while (relaxation_time < Dt)
{
    Real dt = SMIN(get_fluid_time_step_size.exec(), Dt);

    // ========== 前半步 ==========
    pressure_relaxation.exec(dt);
    // → 调用 Integration1stHalfWithWallRiemann
    // → Inner交互 + Wall交互
    // → drho_dt_[i] = rho_dissipation × ρ  (黎曼耗散)
    // → force_[i] = 压力梯度力
    // → v^(n+1/2) = v^n + F/m × dt

    constant_gravity.exec(dt);
    // → v^(n+1/2) += g × dt

    // ========== 后半步 ==========
    density_relaxation.exec(dt);
    // → 调用 Integration2ndHalfWithWallNoRiemann
    // → Inner交互 + Wall交互
    // → drho_dt_[i] += density_change_rate × ρ  (连续性方程)
    // → force_[i] = 0 × V_i = 0  (NoRiemann)
    // → ρ^(n+1) = ρ^(n+1/2) + drho_dt_ × dt/2

    relaxation_time += dt;
    integration_time += dt;
    GlobalStaticVariables::physical_time_ += dt;
}
```

---

## 总结

### 三个关键点

1. **用户高亮的代码位于前半步**
   - `drho_dt_[index_i] = rho_dissipation * rho_[index_i];`
   - 这是黎曼耗散项，基于压力差
   - 使用 `=` 替换操作

2. **后半步累加到前半步的结果**
   - `drho_dt_[index_i] += density_change_rate * rho_[index_i];`
   - 这是连续性方程，基于速度散度
   - 使用 `+=` 累加操作

3. **NoRiemann不意味着无密度更新**
   - NoRiemann只是关闭黎曼耗散项和传输速度修正
   - 连续性方程永远存在（这是质量守恒的基础）
   - 后半步的NoRiemann仅让 `force_[i] = 0`

### 当前配置的合理性

```
1st Half: Riemann  + 2nd Half: NoRiemann
          ^^^^^^^^              ^^^^^^^^^^
          稳定压力场            高效率

适用于：Re=100的低速泊肃叶流
```

如果改为 `1st Half: NoRiemann`，压力会振荡严重！
如果改为 `2nd Half: Riemann`，计算量增加但效果提升不明显（对本例）。
