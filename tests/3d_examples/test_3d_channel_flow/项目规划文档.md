# 3D 槽道流动案例构建任务清单

## 项目简介
- 目标：在 SPHinXsys 平台上搭建三维槽道（Poiseuille 型）流动算例，复现并扩展二维基准，保障后续 FSI / 热耦合拓展的物理一致性。
- 交付：完整的 `test_3d_channel_flow` 案例目录（含 `case_name.cpp`、`CMakeLists.txt`、输入输出资源）、可复现的编译运行脚本及后处理工具链。
- 约束：对齐《项目Case构建指南.md》与 2D 基准参数；遵循《SPHinXsys_Workflow_Cookbook.md》提供的工作流规范，保证从源码到可视化的闭环复现。

## 文档资源与阅读任务
- [ ] `项目Case构建指南.md`：案例骨架、动力学配置与常见问题的操作手册 —— 已通读，用于阶段 2~4 的流程对照。
- [ ] `SPHinXsys_Workflow_Cookbook.md`：构建、运行、MATLAB 后处理的复现工作流 —— 已阅读，用于阶段 6 的交付规范。
- [ ] `索引.md`：函数到源文件的映射速查 —— 尚需针对本案例列出关键 API 的源码行号，可在阶段 1/4 中逐项补完。
- [ ] `2d_example/`：含 `channel_flow_shell.cpp` 及其 `CMakeLists.txt`、输入输出脚本 —— 已完成首次阅读，用作 3D 案例流程参考。


## 阶段 1：需求梳理与基准分析
- [ ] 正式确认物理目标、运行模式（粒子松弛 / 重载 / 正常求解）以及需要输出的观测量，明确 `BodyStatesRecordingToVtp`、`ObservedQuantityRecording` 需要写出的变量字段与采样频率，记录约束条件（目标雷诺数、入口速度、期望稳态时间）。
- [ ] 精读 `2d_example/channel_flow_shell.cpp` 与其 `CMakeLists.txt`，抽取几何定义（`MultiPolygonShape`）、壁面粒子生成器、嵌套时间循环、VTK/观测输出与 GTest 校验流程，标注二维实现中自定义入口初值 `InitialVelocity`、`PeriodicConditionUsingCellLinkedList` 与 `updateCellLinkedList()` 的具体位置及可复用模式。
- [ ] 浏览 `tests/3d_examples/test_3d_poiseuille_flow_shell/`、`test_3d_FVM_incompressible_channel_flow/` 等案例，整理 3D 构建在粒子生成（`generateParticlesWithReserve<BaseParticles, Lattice>`、自定义 `ParticleGenerator`）、几何建模（`ComplexShape` + STL/TriangleMesh）、周期/开边界组合、观察点布置及测试集成（GTest、ParticleBuffer）的差异，形成 2D→3D 对照表。
- [ ] 结合《索引.md》中“粒子生成器”“边界条件”“时间步长”章节，汇总 3D 槽道需要的关键接口：`PeriodicConditionInAxisDirection::update_cell_linked_list_.exec()` / `bounding_.exec()`、`fluid_dynamics::AcousticTimeStep`、`fluid_dynamics::DensitySummationComplex`、`fluid_dynamics::PressureRelaxationFirstHalf`、`fluid_dynamics::PressureRelaxationSecondHalf`、`fluid_dynamics::ViscousAcceleration`、`EmitterInflowInjection`。

## 阶段 2：几何与物性设计
- [ ] 明确槽道长宽高、入口/出口缓冲区及 `resolution_ref`，计算粒子间距 `particle_spacing = H / N_y`，推导 `BoundingBox system_domain_bounds(Vecd(lower_corner), Vecd(upper_corner))` 与背景网格大小 `Vecu number_of_particles`，分别为流向（x）与横向（z）周期方向预留缓冲长度，仅在竖直方向（y）布置壁面空间。
- [ ] 设定流体材料参数 `rho0_f`、`c_f`、`mu_f`，依据目标雷诺数 `Re = rho0_f * U_ref * H / mu_f` 反推入口速度 `U_ref` 与压力梯度 `dp/dx = 12 * mu_f * U_ref / (rho0_f * H^2)`（平板泊肃叶解析解：`U_ref = -H^2/(12μ) * (1/ρ dp/dx)`），同步推导恒定体力 `f_x = -dp/dx / rho0_f`；计算 `dt_acoustic = CFL * particle_spacing / (c_f + 1.2 * U_ref)`、`dt_viscous = 0.5 * particle_spacing^2 * rho0_f / mu_f` 并记录取值逻辑（外层对流步 `Dt = min(dt_acoustic, dt_viscous)`，内层声速步 `dt_inner` 由压力松弛返回），确认体力 `gravity = Vecd(0, 0, -9.81)` 是否启用。
- [ ] 规划壁面/包络体：确定 `class ChannelGeometry : public ComplexShape` 中 `addAPolygon` / `subtractShape` 步骤或 STL 导入路径，决定是否构建 `SolidBody wall_boundary` 并使用 `solid_dynamics::NormalDirectionSummation`、`fluid_dynamics::ForceOnSolidUpdate` 进行流固相互作用。

## 阶段 3：案例骨架搭建
- [ ] 按《项目Case构建指南.md》第 2 章创建目录与 `case_name.cpp`、`CMakeLists.txt`、`input/`、`regression_test_tool/`，在 `tests/3d_examples/CMakeLists.txt` 添加 `add_sphinxsys_test(NAME test_3d_channel_flow ...)` 并在顶层 `tests/CMakeLists.txt` 注册；若需回归，配置 `enable_regression_test()`。
- [ ] 在源文件中包含 `sphinxsys.h`，声明常量（几何尺寸、`resolution_ref`、`rho0_f` 等），根据 2D 模板编写 3D `ChannelGeometry`（继承 `ComplexShape`，组合长方体/圆柱或引入 STL），构建 `SPHSystem sph_system(system_domain_bounds, resolution_ref);`, 设置 `sph_system.setRunParticleRelaxation(true/false);`, `sph_system.setReloadParticles(false);`，如需松弛可在后续步骤补充 `RandomizeParticlePosition`。
- [ ] 创建 `FluidBody fluid_body(sph_system, makeShared<ChannelGeometry>("Channel"));`, 选择 `generateParticlesWithReserve<BaseParticles, Lattice>` 搭配 `ParticleBuffer<ReserveSizeFactor>` 以支持入口注入（参考 3D Poiseuille）；如有刚性壁体，构建专用 `ParticleGenerator<SurfaceParticles, WallBoundary>` 并生成 `SolidBody`；为监测剖面创建 `ObserverBody`，布置轴向/径向测点。

## 阶段 4：体关系、边界与动力学
- [ ] 定义 `InnerRelation fluid_inner(fluid_body);`, `ComplexRelation fluid_complex(fluid_body, {&wall_body});`, `ContactRelation observer_contact(observer_body, {&fluid_body});`；针对周期方向分别实例化 `PeriodicConditionInAxisDirection periodic_condition_x(fluid_body, xAxis);` 与 `periodic_condition_z(fluid_body, zAxis);`，明确两步流程：`bounding_.exec()` 负责粒子越界平移、`update_cell_linked_list_.exec()` 复制镜像粒子以补齐邻居（参考完全验证版 §1.2~1.3），调用顺序位于 `initializeSystemCellLinkedLists()` / `initializeSystemConfigurations()` 之间并在每个内循环前后执行。
- [ ] 配置动力学模块：`ReduceDynamics<fluid_dynamics::AcousticTimeStep> get_fluid_time_step(fluid_body);`, `InteractionWithUpdate<fluid_dynamics::DensitySummationComplex> update_density(fluid_complex);`, `Dynamics1Level<fluid_dynamics::PressureRelaxationFirstHalf> pressure_relaxation(fluid_inner);`, `Dynamics1Level<fluid_dynamics::PressureRelaxationSecondHalf> density_relaxation(fluid_inner);`, `InteractionWithUpdate<fluid_dynamics::ViscousForceWithWall>` / `InteractionSplit<fluid_dynamics::ViscousAcceleration>`，`SimpleDynamics<GravityForce<Gravity>> gravity_force(fluid_body, gravity);`，必要时引入 `TransportVelocityCorrection`、`ParticleSorting` 等 2D 案例中的稳定化步骤。
- [ ] 设计边界条件与注入：若采用恒压驱动，定义 `class InflowVelocityCondition : public fluid_dynamics::EmitterInflowCondition` 返回抛物线分布（参考 `poiseuille_flow_shell.cpp` 中的 `InflowVelocity` functor），结合 `AlignedBoxByParticle`、`ParticleBuffer` 与 `SimpleDynamics<fluid_dynamics::EmitterInflowInjection>`；出口利用 `DisposerOutflowDeletion` 或静态限域；顶部/底部沿竖直方向（y）维持固壁 `SolidBody` 接触条件，其余左右/前后方向通过周期边界闭合；初始条件继承 `fluid_dynamics::FluidInitialCondition`，按 3D 几何设置速度/压力场。

## 阶段 5：主循环、输出与验证
- [ ] 编写主循环：仿照 2D 通道结构设置“输出间隔 -> 对流步 Dt -> 内部松弛循环”三层嵌套，执行 `update_density.exec();`、`viscous_acceleration.exec();`、`transport_correction.exec();` 等预测步骤，再在 `while (relaxation_time < Dt)` 中依次调用 `periodic_condition_x.bounding_.exec();`, `periodic_condition_z.bounding_.exec();`, `pressure_relaxation.initializeAndInteraction(dt_inner);`, `pressure_relaxation.update(dt_inner);`, `gravity_force.exec(dt_inner);`, `density_relaxation.initializeAndInteraction(dt_inner);`, `density_relaxation.update(dt_inner);`, `periodic_condition_x.update_cell_linked_list_.exec();`, `periodic_condition_z.update_cell_linked_list_.exec();`，并在每次循环后更新配置与累积时间。
- [ ] 设置输出：实例化 `BodyStatesRecordingToVtp write_real_body_states(sph_system);`, 轴向/径向观察器 `ObservedQuantityRecording<Vecd>`，全局量 `ReducedQuantityRecording<TotalKineticEnergy>`；若后续需要回归测试，可选接入 `RegressionTestDynamicTimeWarping`；按 2D 模板在外层循环末尾写 VTP、观测数据及屏幕日志。
- [ ] 验证方案：推导 3D Poiseuille 解析解 `u(r) = (dp/dx)/(4μ) (R^2 - r^2)` 或体力驱动形式，生成 MATLAB 对比脚本；参考 2D 案例的 GTest 结构，引入 `EXPECT_NEAR` 对观察点速度进行误差评估。
  - （2025-10-21）最新 100 s 运行：中心线 `max|err| ≈ 2.9e-2`、`RMS ≈ 1.9e-2`，峰值 `U_max ≈ 1.529`；壁面法/展向残差约 `7e-3`。GTest 仍以 `2e-2` 容差通过，`output/timing_summary.txt` 记录 TickCount ≈ 1762 s / steady_clock ≈ 1876 s 的耗时。

## 阶段 6：交付与复现工作流
- [ ] 对齐《SPHinXsys_Workflow_Cookbook.md》第 1~4 节与现有 2D/3D 案例 README，编写项目级说明：涵盖初始环境、CMake/VS 构建、`build.bat` 使用、输出目录结构、MATLAB 预处理/可视化入口、GTest 运行方式、典型结果截图。
- [ ] 在案例目录下创建 `build.bat`（或 `build.sh`），沿用 3D Poiseuille 模板：包含输出备份、目标名配置、`cmake --build` 调用、可执行文件运行及可选参数；若存在多分辨率测试，支持参数化调用。
- [ ] 根据 Cookbook【步骤三】编写 `preprocess_data.m` 与 `visualize_flow.m`，与 2D 脚本保持接口一致（输出 `flow_data.mat`、双视图动画、解析曲线对比），并在脚本头部注明从 `.cpp` 中读取的物理参数和周期长度。
- [ ] 整理复现指南：明确“一键运行”流程（`build.bat` → MATLAB `preprocess_data` → `visualize_flow`），列出常见陷阱（文件自然排序、arrayfun 访问结构体、颜色范围、粒子缓冲刷新）及排查清单。
- [ ] 更新《索引.md》、`CHANGELOG.md` 等记录，标注新增脚本、观察点、GTest 用例与潜在扩展方向（热耦合、粗细化网格、FSI、GPU）。

## 附录：关键计算步骤与原理摘要
- 周期性边界：遵循完全验证版 §1.2~§1.3 的双阶段策略，第一步 `bounding_.exec()` 将越界粒子沿流向平移一个周期长度 `Lx`；第二步 `update_cell_linked_list_.exec()` 为靠近边界的粒子写入镜像副本，保证邻域搜索完整，并在每个内循环中先于邻域更新执行。
- 时间步长分层：外层对流步 `Dt = min(dt_acoustic, dt_viscous)` 由 `AcousticTimeStep` 与粘性 CFL 同时约束；内层声波步 `dt_inner` 由压力松弛返回，通常在 `Dt` 内自适应迭代多次，形成“外层对流 + 内层声波”的嵌套结构。
- 压力/密度松弛半步交错：`Integration1stHalf` 先进行初始化、相互作用与更新，得到速度半步并叠加体力；`Integration2ndHalf` 负责位置与密度校正，完成 `ρⁿ → ρⁿ⁺¹/² → ρⁿ⁺¹`、`xⁿ → xⁿ⁺¹/² → xⁿ⁺¹` 的 staggered 积分（参照完全验证版 §3~§4）。
- 粘性力与粒子分布修正：`ViscousForce` 采用对称梯度与正则化距离 `r_ij^2 + η h^2`，如需加强粒子均匀性可追加 `TransportVelocityCorrection`；两者配合确保高雷诺数下的数值稳定。
- 泊肃叶驱动力：若使用体力驱动，按 `f_x = 12 μ U_ref / (ρ H^2)` 施加恒定加速度，并验证 `U_max = 1.5 U_ref`；若采用压力梯度输入，需在初始条件与后处理分析中保持同一公式，以便解析对比。
- 状态方程与物性：弱可压流体满足 `p = c_f^2 (ρ - ρ0)`，声速系数通常取 `c_f ≈ 10 U_ref` 以保持低马赫数；密度更新通过 `DensitySummation` 完成，并在回归/可视化脚本中跟踪守恒量变化。

## 附录：关键接口源码速查
- `PeriodicConditionUsingCellLinkedList`：定义见 `src/shared/particle_dynamics/general_dynamics/domian_bouding/domain_bounding.h:142`，构造函数与 `bounding_` / `update_cell_linked_list_` 的实现位于 `src/shared/particle_dynamics/general_dynamics/domian_bouding/domain_bounding.cpp:6-54`；二维通道案例中的调用样例 `tests/2d_examples/test_2d_channel_flow_fluid_shell/channel_flow_shell.cpp:219-221`。
- `ReduceDynamics<fluid_dynamics::AcousticTimeStep>`：接口定义在 `src/shared/particle_dynamics/fluid_dynamics/fluid_time_step.h:45-58`，求解声速 CFL 的逻辑位于 `src/shared/particle_dynamics/fluid_dynamics/fluid_time_step.cpp:10-29`；三维 Poiseuille 案例调用 `tests/3d_examples/test_3d_poiseuille_flow_shell/poiseuille_flow_shell.cpp:230`。
- `InteractionWithUpdate<fluid_dynamics::DensitySummationComplex>`：别名声明 `src/shared/particle_dynamics/fluid_dynamics/density_summation.h:182`，内/接触求和模板在同文件 52-188 行；三维 Poiseuille 案例调用 `tests/3d_examples/test_3d_poiseuille_flow_shell/poiseuille_flow_shell.cpp:225`。
- `Dynamics1Level<fluid_dynamics::Integration1stHalfWithWallRiemann>` / `Dynamics1Level<fluid_dynamics::Integration2ndHalfWithWallNoRiemann>`：模板定义 `src/shared/particle_dynamics/fluid_dynamics/fluid_integration.h:45-212`，对应实现 `src/shared/particle_dynamics/fluid_dynamics/fluid_integration.hpp:26-205`；典型调用 `tests/3d_examples/test_3d_poiseuille_flow_shell/poiseuille_flow_shell.cpp:223-224`。
- `InteractionWithUpdate<fluid_dynamics::ViscousForceWithWall>`：模板别名 `src/shared/particle_dynamics/fluid_dynamics/viscous_dynamics.h:113-162`，力计算细节在 `src/shared/particle_dynamics/fluid_dynamics/viscous_dynamics.hpp:12-164`；三维 Poiseuille 案例调用 `tests/3d_examples/test_3d_poiseuille_flow_shell/poiseuille_flow_shell.cpp:226`。
- `SimpleDynamics<fluid_dynamics::EmitterInflowInjection>`：类定义 `src/shared/particle_dynamics/fluid_dynamics/boundary_condition/fluid_boundary.h:222-248`，实现 `src/shared/particle_dynamics/fluid_dynamics/boundary_condition/fluid_boundary.cpp:61-88`；案例调用 `tests/3d_examples/test_3d_poiseuille_flow_shell/poiseuille_flow_shell.cpp:235`。
- `BodyStatesRecordingToVtp`：接口在 `src/shared/io_system/io_vtk.h:46-51`，写文件逻辑 `src/shared/io_system/io_vtk.cpp:8-157`；案例调用 `tests/3d_examples/test_3d_poiseuille_flow_shell/poiseuille_flow_shell.cpp:247`。
- `ObservedQuantityRecording<Vec3d>` 与 `ReducedQuantityRecording<TotalKineticEnergy>`：接口分别位于 `src/shared/io_system/io_observation.h:56-107` 与 `src/shared/io_system/io_observation.h:124-166`；观测点写出示例 `tests/3d_examples/test_3d_poiseuille_flow_shell/poiseuille_flow_shell.cpp:252-253`。
- `PeriodicAlongAxis` 辅助结构体：定义于 `src/shared/particle_dynamics/general_dynamics/domian_bouding/domain_bounding.h:27-54`，与上面周期条件配套使用，在 2D 通道示例里构造于 `tests/2d_examples/test_2d_channel_flow_fluid_shell/channel_flow_shell.cpp:219-221`。
