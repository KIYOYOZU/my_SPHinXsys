# SPH é€šé“æµç®—æ³•è¯¦è§£ï¼ˆå®Œå…¨éªŒè¯ç‰ˆï¼‰

**è®°å½•æ—¥æœŸ**: 2025-10-15
**é¡¹ç›®**: SPHinXsys - 2D Channel Flow (Weakly Compressible SPH)
**ç‰ˆæœ¬**: å®Œå…¨éªŒè¯ç‰ˆ v2.0
**éªŒè¯çŠ¶æ€**: æ‰€æœ‰å…¬å¼å’Œä»£ç å·²é€è¡ŒéªŒè¯

---

## é‡è¦è¯´æ˜

æœ¬æ–‡æ¡£ä¸­çš„æ‰€æœ‰å…¬å¼å’Œç®—æ³•æè¿°å‡å·²é€šè¿‡**æ·±å…¥è¿½è¸ªæºä»£ç **éªŒè¯ï¼ŒåŒ…æ‹¬å¤šå±‚å‡½æ•°è°ƒç”¨ã€‚æ¯ä¸ªæ­¥éª¤éƒ½æ ‡æ³¨äº†å¯¹åº”çš„æºæ–‡ä»¶å’Œè¡Œå·ã€‚

---

## ç›®å½•

1. [å‘¨æœŸæ€§è¾¹ç•Œæ¡ä»¶å®ç°](#ä¸€å‘¨æœŸæ€§è¾¹ç•Œæ¡ä»¶å®ç°)
   - 1.1 [åŸå§‹æ–¹æ³•çš„é—®é¢˜](#11-åŸå§‹æ–¹æ³•çš„é—®é¢˜)
   - 1.2 [å‘¨æœŸæ€§è¾¹ç•Œè®¾ç½®](#12-å‘¨æœŸæ€§è¾¹ç•Œè®¾ç½®)
   - 1.3 [è™šæ‹Ÿé•œåƒç²’å­](#13-è™šæ‹Ÿé•œåƒç²’å­)
   - 1.4 [å£é¢è¾¹ç•Œæ¡ä»¶è®¾ç½®](#14-å£é¢è¾¹ç•Œæ¡ä»¶è®¾ç½®)
   - 1.5 [è¾¹ç•Œæ¡ä»¶çš„ç‰©ç†æœºåˆ¶](#15-è¾¹ç•Œæ¡ä»¶çš„ç‰©ç†æœºåˆ¶)
   - 1.6 [è¾¹ç•Œæ¡ä»¶åœ¨ä¸»å¾ªç¯ä¸­çš„åº”ç”¨](#16-è¾¹ç•Œæ¡ä»¶åœ¨ä¸»å¾ªç¯ä¸­çš„åº”ç”¨)
   - 1.7 [è¾¹ç•Œæ¡ä»¶éªŒè¯](#17-è¾¹ç•Œæ¡ä»¶éªŒè¯)
2. [ç®—æ³•æ€»ä½“æ¡†æ¶](#äºŒç®—æ³•æ€»ä½“æ¡†æ¶)
3. [å¤–å±‚å¾ªç¯ï¼šå¯¹æµæ—¶é—´æ­¥](#ä¸‰å¤–å±‚å¾ªç¯å¯¹æµæ—¶é—´æ­¥-dt)
4. [å†…å±‚å¾ªç¯ï¼šå£°æ³¢æ—¶é—´æ­¥](#å››å†…å±‚å¾ªç¯å£°æ³¢æ—¶é—´æ­¥-dt)
5. [é»æ›¼æ±‚è§£å™¨çš„ä½œç”¨](#äº”é»æ›¼æ±‚è§£å™¨çš„ä½œç”¨)
6. [ä½“åŠ›é©±åŠ¨è®¾ç½®](#å…­ä½“åŠ›é©±åŠ¨è®¾ç½®)
7. [å…³é”®æŠ€æœ¯ç»†èŠ‚](#ä¸ƒå…³é”®æŠ€æœ¯ç»†èŠ‚)

---

## ä¸€ã€å‘¨æœŸæ€§è¾¹ç•Œæ¡ä»¶å®ç°

### 1.1 åŸå§‹æ–¹æ³•çš„é—®é¢˜

**åŸå§‹è®¾è®¡**ï¼šè®¡ç®—åŸŸå·¦ä¾§è®¾ç½®ç¼“å†²åŒºåŸŸï¼Œä¸»å¾ªç¯ä¸­å¼ºåˆ¶ä¿®æ”¹ç¼“å†²åŒºåŸŸå†…ç²’å­çš„é€Ÿåº¦

```cpp
AlignedBoxByCell inflow_buffer(...);
SimpleDynamics<fluid_dynamics::InflowVelocityCondition<InflowVelocity>>
    parabolic_inflow(inflow_buffer);
parabolic_inflow.exec();
```

**ç¼ºç‚¹**ï¼š
- éœ€è¦é¢å¤–çš„ç¼“å†²åŒºé•¿åº¦
- äººä¸ºå¼ºåˆ¶è®¾ç½®é€Ÿåº¦ï¼Œç ´åç‰©ç†å®ˆæ’æ€§
- æ— æ³•çœŸæ­£æ¨¡æ‹Ÿå‘¨æœŸæ€§æµåŠ¨

### 1.2 å‘¨æœŸæ€§è¾¹ç•Œè®¾ç½®

**æ ¸å¿ƒæ€æƒ³**ï¼šç²’å­è¶Šè¿‡å³è¾¹ç•Œåï¼Œç›´æ¥å¹³ç§»åˆ°å·¦ä¾§

**å…³é”®å‡ ä½•å‚æ•°**ï¼š
- `DL = 10.0 m`ï¼š**é€šé“é•¿åº¦**ï¼ˆxæ–¹å‘ï¼ŒæµåŠ¨æ–¹å‘ï¼‰
- `DH = 2.0 m`ï¼š**é€šé“é«˜åº¦**ï¼ˆyæ–¹å‘ï¼Œå‚ç›´æ–¹å‘ï¼‰
- å‘¨æœŸæ€§æ–¹å‘ï¼š**xè½´**ï¼ˆæ²¿æµåŠ¨æ–¹å‘ï¼‰

**ä»£ç å®ç°**ï¼ˆå¹³ç§»è¶Šç•Œç²’å­ï¼‰ï¼š
```cpp
// channel_flow_shell.cpp:211
PeriodicAlongAxis periodic_along_x(water_block.getSPHBodyBounds(), xAxis);

// åº•å±‚å®ç°ï¼ˆç²’å­å¹³ç§»ï¼‰
virtual void checkUpperBound(size_t index_i, Real dt = 0.0)
{
    if (pos_[index_i][axis_] > bounding_bounds_.second_[axis_]) // è¶Šè¿‡å³è¾¹ç•ŒDL
        pos_[index_i][axis_] -= periodic_translation_[axis_]; // å¹³ç§»åˆ°å·¦ä¾§ = DL
};
```

**ç¤ºä¾‹**ï¼š
```
ç²’å­Aï¼šx = 10.01 mï¼ˆè¶Šè¿‡å³è¾¹ç•ŒDL=10.0ï¼‰
  â†“ å¹³ç§» -= DL
ç²’å­A'ï¼šx = 0.01 mï¼ˆå›åˆ°å·¦ä¾§ï¼‰
```

### 1.3 è™šæ‹Ÿé•œåƒç²’å­

**é—®é¢˜**ï¼šè¾¹ç•Œé™„è¿‘ç²’å­çš„æœç´¢åŠå¾„å¯èƒ½è¶…å‡ºè¾¹ç•Œï¼Œå¯¼è‡´é‚»å±…åˆ—è¡¨ä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆ**ï¼šä¸ºå·¦è¾¹ç•Œé™„è¿‘çš„ç²’å­åˆ›å»ºè™šæ‹Ÿé•œåƒç²’å­åœ¨å³è¾¹ç•Œ

**è¯†åˆ«è¾¹ç•Œé™„è¿‘ç²’å­**ï¼š
```cpp
// å·¦è¾¹ç•Œé™„è¿‘ï¼ˆ0 < x < cut_off_radiusï¼‰
if (particle_position[axis_] > bounding_bounds_.first_[axis_] &&
    particle_position[axis_] < (bounding_bounds_.first_[axis_] + cut_off_radius_max_))
{
    // è®¡ç®—é•œåƒä½ç½®ï¼šx_mirror = x_real + DL
    Vecd translated_position = particle_position + periodic_translation_;
    // periodic_translation_[xAxis] = DL = 10.0

    // çº¿ç¨‹å®‰å…¨åœ°æ’å…¥è™šæ‹Ÿç²’å­
    mutex_cell_list_entry_.lock();
    cell_linked_list_.InsertListDataEntry(..., translated_position);
    mutex_cell_list_entry_.unlock();
}
```

**æ•°å€¼ä¾‹å­**ï¼š
```
çœŸå®ç²’å­Bï¼šx = 0.1 mï¼ˆå·¦è¾¹ç•Œé™„è¿‘ï¼‰
é•œåƒç²’å­B'ï¼šx = 0.1 + 10.0 = 10.1 mï¼ˆè™šæ‹Ÿæ’å…¥å³è¾¹ç•Œï¼‰
```

**å›¾ç¤º**ï¼š
```
çœŸå®ç²’å­B (x=0.1)              ç²’å­A (x=9.9)
    â€¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€¢
    â”‚      DL=10m                     â”‚ â† æœç´¢åŠå¾„
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      è™šæ‹Ÿç²’å­B' (x=10.1)
                                          â€¢
```

### 1.4 å£é¢è¾¹ç•Œæ¡ä»¶è®¾ç½®

#### å£é¢ç²’å­ç”Ÿæˆ

**ä»£ç ä½ç½®**ï¼š
```cpp
// channel_flow_shell.cpp:162-164
SolidBody wall_boundary(sph_system, makeShared<DefaultShape>("Wall"));
wall_boundary.defineMaterial<Solid>();
wall_boundary.generateParticles<SurfaceParticles, WallBoundary>(resolution_ref, wall_thickness);
```

**ç²’å­ç”Ÿæˆå™¨å®ç°**ï¼š
```cpp
// channel_flow_shell.cpp:38-72
template <>
class ParticleGenerator<SurfaceParticles, WallBoundary> : public ParticleGenerator<SurfaceParticles>
{
    Real DL_sponge_;          // ç¼“å†²åŒºé•¿åº¦ = 20 Ã— resolution_ref
    Real BW_;                 // è¾¹ç•Œå®½åº¦ = 4 Ã— resolution_ref
    Real resolution_ref_;     // ç²’å­é—´è·
    Real wall_thickness_;     // å£é¢åšåº¦

public:
    void prepareGeometricData() override
    {
        auto particle_number_mid_surface = int((DL + DL_sponge_ + 2 * BW_) / resolution_ref_);

        for (int i = 0; i < particle_number_mid_surface; i++)
        {
            Real x = -DL_sponge_ - BW_ + (Real(i) + 0.5) * resolution_ref_;

            // ä¸Šå£é¢ï¼ˆy = DH + 0.5 Ã— resolution_refï¼‰
            Real y1 = DH + 0.5 * resolution_ref_;
            addPositionAndVolumetricMeasure(Vecd(x, y1), resolution_ref_);
            Vec2d normal_direction_1 = Vec2d(0, 1.0);  // æ³•å‘é‡å‘ä¸Š
            addSurfaceProperties(normal_direction_1, wall_thickness_);

            // ä¸‹å£é¢ï¼ˆy = -0.5 Ã— resolution_refï¼‰
            Real y2 = -0.5 * resolution_ref_;
            addPositionAndVolumetricMeasure(Vecd(x, y2), resolution_ref_);
            Vec2d normal_direction_2 = Vec2d(0, -1.0);  // æ³•å‘é‡å‘ä¸‹
            addSurfaceProperties(normal_direction_2, wall_thickness_);
        }
    }
};
```

**å‡ ä½•å‚æ•°**ï¼š
- ç²’å­æ€»æ•°ï¼š`particle_number_mid_surface = (DL + DL_sponge + 2*BW) / resolution_ref`
  - `DL = 10.0 m`
  - `DL_sponge = 20 Ã— 0.05 = 1.0 m`
  - `BW = 4 Ã— 0.05 = 0.2 m`
  - æ€»é•¿åº¦ = 10.0 + 1.0 + 0.4 = 11.4 m
  - ç²’å­æ•° = 11.4 / 0.05 = 228ä¸ªï¼ˆæ¯ä¸ªå£é¢ï¼‰

**å£é¢ä½ç½®**ï¼š
```
ä¸Šå£é¢ï¼šy = DH + 0.5 Ã— dp = 2.0 + 0.025 = 2.025 m
ä¸‹å£é¢ï¼šy = -0.5 Ã— dp = -0.025 m
xèŒƒå›´ï¼š[-1.2, 10.2] mï¼ˆåŒ…å«ç¼“å†²åŒºå’Œè¾¹ç•Œå®½åº¦ï¼‰
```

**å›¾ç¤º**ï¼š
```
y = 2.025 m  â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—  ä¸Šå£é¢ï¼ˆ228ä¸ªç²’å­ï¼‰
             â”‚                          â”‚
             â”‚    æµä½“åŸŸï¼ˆ0 < y < 2ï¼‰    â”‚
             â”‚                          â”‚
y = -0.025 m â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—  ä¸‹å£é¢ï¼ˆ228ä¸ªç²’å­ï¼‰
           x=-1.2                    x=10.2
```

#### å£é¢æ³•å‘é‡è®¾ç½®

**æ³•å‘é‡å®šä¹‰**ï¼š
- ä¸Šå£é¢ï¼š`normal = (0, 1)`ï¼ŒæŒ‡å‘æµä½“åŸŸå¤–
- ä¸‹å£é¢ï¼š`normal = (0, -1)`ï¼ŒæŒ‡å‘æµä½“åŸŸå¤–

**ä½œç”¨**ï¼š
1. è®¡ç®—å£é¢ä¸æµä½“çš„ç›¸å¯¹ä½ç½®
2. ç”¨äºç²˜æ€§åŠ›å’Œå‹åŠ›çš„å£é¢å¤„ç†
3. ç¡®å®šæµä½“-å£é¢ç›¸äº’ä½œç”¨æ–¹å‘

#### å£é¢åšåº¦å‚æ•°

**ä»£ç è®¾ç½®**ï¼š
```cpp
// channel_flow_shell.cpp:360
const Real wall_thickness = 10 * resolution_ref = 0.5 m;
```

**ç‰©ç†æ„ä¹‰**ï¼š
- ç”¨äºå£é¢ç²’å­çš„æ³•å‘å°ºå¯¸
- å½±å“æµä½“-å£é¢ç›¸äº’ä½œç”¨çš„æœç´¢èŒƒå›´
- é€šå¸¸è®¾ç½®ä¸º `(5-10) Ã— resolution_ref`

### 1.5 è¾¹ç•Œæ¡ä»¶çš„ç‰©ç†æœºåˆ¶

**æœ¬ç« èŠ‚éªŒè¯çŠ¶æ€**ï¼ˆ2025-10-15æºç éªŒè¯ï¼‰ï¼š
- âœ… **å®Œå…¨éªŒè¯**ï¼š11é¡¹å†…å®¹æœ‰ç›´æ¥æºç ä¾æ®
- ğŸ“š **ç†è®ºæ¨å¯¼**ï¼š2é¡¹å†…å®¹åŸºäºç‰©ç†åŸç†æ¨å¯¼ï¼ˆå·²æ ‡æ³¨"ç†è®ºæ¨å¯¼"ï¼‰
- âš ï¸ **éƒ¨åˆ†éªŒè¯**ï¼š1é¡¹å†…å®¹å®é™…æœºåˆ¶ä¸é¢„æœŸä¸åŒï¼ˆå·²æ ‡æ³¨"å®é™…å®ç°"ï¼‰

**éªŒè¯æ–¹æ³•**ï¼šé€æ¡è¿½è¸ªSPHinXsysæºç ï¼ˆv2024ç‰ˆæœ¬ï¼‰

**ä¸»è¦æºç æ–‡ä»¶**ï¼š
- `viscous_dynamics.hpp`ï¼šç²˜æ€§åŠ›å®ç°
- `fluid_integration.hpp`ï¼šå‹åŠ›æ¾å¼›ä¸å£é¢å‹åŠ›é™åŠ›å­¦å¤–æ¨
- `surface_particles.h`ï¼šå£é¢ç²’å­å®šä¹‰ï¼ˆæ— å‹åŠ›å˜é‡ï¼‰
- `base_fluid_dynamics.h`ï¼šå£é¢ç›¸äº’ä½œç”¨åŸºç±»ï¼ˆæ— å‹åŠ›æ•°ç»„ï¼‰

**å…³é”®å‘ç°**ï¼š
- âœ… å£é¢ç”±çœŸå®`SurfaceParticles`è¡¨ç¤ºï¼ˆéè™šæ‹Ÿç²’å­ï¼‰
- ğŸ“š é•œåƒé€Ÿåº¦ä¸ºç†è®ºç­‰æ•ˆæ¦‚å¿µï¼ˆä»£ç ç›´æ¥ç”¨`2.0*`ç³»æ•°ä½“ç°ï¼‰
- âš ï¸ å£é¢å‹åŠ›é‡‡ç”¨**é™åŠ›å­¦å¤–æ¨**ï¼ˆéæ ‡å‡†SPHå¤–æ¨ï¼‰ï¼Œå³æ—¶è®¡ç®—æ— é¢„å­˜å‚¨

---

#### æµä½“-å£é¢ç›¸äº’ä½œç”¨çš„ç†è®ºåŸºç¡€

**ç‰©ç†æ¨¡å‹**ï¼š

SPHä¸­çš„å£é¢è¾¹ç•Œå¤„ç†åŸºäº**è¾¹ç•Œç²’å­æ³•**ï¼ˆBoundary Particle Methodï¼‰ï¼š
- å£é¢ç”±**çœŸå®çš„`SurfaceParticles`**è¡¨ç¤ºï¼ˆæ°¸ä¹…å­˜åœ¨ï¼Œéä¸´æ—¶è™šæ‹Ÿç²’å­ï¼‰
- æµä½“ç²’å­ä¸å£é¢ç²’å­ä¹‹é—´é€šè¿‡æ ‡å‡†SPHæ’å€¼ç›¸äº’ä½œç”¨
- å£é¢æ³•å‘é‡ç”¨äºç¡®å®šåŠ›çš„æ–¹å‘å’Œè¾¹ç•Œæ¡ä»¶

**æºç ä¾æ®**ï¼š
- `surface_particles.h:40-48`ï¼š`SurfaceParticles`ç±»å®šä¹‰ï¼Œæ— å‹åŠ›å˜é‡
- `channel_flow_shell.cpp:162-164`ï¼šå£é¢ç²’å­ç”Ÿæˆï¼ˆçœŸå®ç²’å­ï¼Œæ°¸ä¹…å­˜åœ¨ï¼‰

**å…³é”®å‡è®¾**ï¼š
1. **æ— æ»‘ç§»è¾¹ç•Œæ¡ä»¶**ï¼šå£é¢å¤„æµä½“é€Ÿåº¦ä¸º0
   $$\mathbf{v}_{\text{fluid}}|_{\text{wall}} = \mathbf{v}_{\text{wall}} = 0$$

2. **æ³•å‘åº”åŠ›å¹³è¡¡**ï¼šå£é¢æ³•å‘å‹åŠ›ç”±æµä½“å‹åŠ›ç¡®å®š
   $$p_{\text{wall}} = p_{\text{fluid}}|_{\text{wall}}$$

3. **å£é¢ä¸å¯ç©¿é€**ï¼šæµä½“ç²’å­ä¸èƒ½ç©¿è¿‡å£é¢
   $$(\mathbf{x}_{\text{fluid}} - \mathbf{x}_{\text{wall}}) \cdot \mathbf{n}_{\text{wall}} \geq 0$$

#### æµä½“-å£é¢ç›¸äº’ä½œç”¨

**å…³ç³»å®šä¹‰**ï¼š
```cpp
// channel_flow_shell.cpp:181
ContactRelationFromShellToFluid water_block_contact(water_block, {&wall_boundary}, {false});
```

**å‚æ•°è¯´æ˜**ï¼š
- `{&wall_boundary}`ï¼šå£é¢ä½“çš„æŒ‡é’ˆåˆ—è¡¨
- `{false}`ï¼šæ³•å‘ä¿®æ­£æ ‡å¿—
  - `false`ï¼šå£é¢æ³•å‘é‡å·²æ­£ç¡®æŒ‡å‘æµä½“â†’å£é¢
  - `true`ï¼šéœ€è¦åè½¬æ³•å‘é‡æ–¹å‘

**ä»£ç -ç‰©ç†å¯¹åº”**ï¼š

| ä»£ç å‚æ•° | ç‰©ç†æ„ä¹‰ | æ•°å€¼/è®¾ç½® |
|---------|---------|----------|
| `water_block` | æµä½“åŸŸSPHç²’å­é›†åˆ | ~4000ä¸ªç²’å­ï¼ˆDLÃ—DH/dpÂ²ï¼‰ |
| `{&wall_boundary}` | å£é¢ç²’å­é›†åˆ | 2Ã—228=456ä¸ªå£é¢ç²’å­ |
| `{false}` | æ³•å‘é‡æ–¹å‘æ­£ç¡®æ€§ | `false`è¡¨ç¤ºæ— éœ€ä¿®æ­£ |

**æ³•å‘é‡æ–¹å‘çº¦å®š**ï¼š

```
æµä½“ç²’å­i â—â”€â”€â”€â”€â”€â†’ n (æ³•å‘é‡) â”€â”€â”€â”€â”€â†’ â— å£é¢ç²’å­j
           è·ç¦» r_ij
```

- `false`ï¼šæ³•å‘é‡`n`ä»æµä½“æŒ‡å‘å£é¢ï¼ˆæ­£ç¡®ï¼‰
- `true`ï¼šæ³•å‘é‡`n`ä»å£é¢æŒ‡å‘æµä½“ï¼ˆéœ€åè½¬ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦æ³•å‘é‡ï¼Ÿ**
1. åˆ¤æ–­æµä½“ç²’å­ç›¸å¯¹äºå£é¢çš„ä½ç½®
2. è®¡ç®—æ³•å‘å’Œåˆ‡å‘åŠ›åˆ†é‡
3. ç¡®ä¿åŠ›çš„æ–¹å‘ç¬¦åˆç‰©ç†ï¼ˆæ³•å‘å‹åŠ›ã€åˆ‡å‘ç²˜æ€§ï¼‰

**ç›¸äº’ä½œç”¨æœºåˆ¶**ï¼š

##### 1. ç²˜æ€§åŠ›å¤„ç†ï¼ˆæ— æ»‘ç§»è¾¹ç•Œï¼‰

**ä»£ç å®ç°**ï¼š
```cpp
// viscous_dynamics.hpp:89-112
Vecd vel_derivative = 2.0 * (vel_[index_i] - vel_ave_k[index_j]) / (r_ij + 0.01 * h);
force += 2.0 * e_ij.dot(K_i * e_ij) * mu * vel_derivative * dW_ij * wall_Vol;
```

**ç‰©ç†åŸç†è¯¦è§£**ï¼š

**1. æ— æ»‘ç§»è¾¹ç•Œæ¡ä»¶çš„æ•°å­¦è¡¨è¾¾**ï¼š

è¿ç»­ä»‹è´¨åŠ›å­¦ä¸­ï¼Œå›ºä½“å£é¢å¤„çš„æµä½“é€Ÿåº¦å¿…é¡»ç­‰äºå£é¢é€Ÿåº¦ï¼š
$$\mathbf{v}_{\text{fluid}}(\mathbf{x}_{\text{wall}}) = \mathbf{v}_{\text{wall}}$$

å¯¹äºé™æ­¢å£é¢ï¼ˆ$\mathbf{v}_{\text{wall}} = 0$ï¼‰ï¼š
$$\mathbf{v}_{\text{fluid}}(\mathbf{x}_{\text{wall}}) = 0$$

**2. SPHç¦»æ•£åŒ–ç­–ç•¥**ï¼š

ğŸ“š **[ç†è®ºæ¨å¯¼]** æ— æ»‘ç§»è¾¹ç•Œæ¡ä»¶çš„ç†è®ºè¦æ±‚ç­‰æ•ˆäº**é•œåƒé€Ÿåº¦**ï¼š
- æµä½“ç²’å­é€Ÿåº¦ï¼š$\mathbf{v}_i$
- å£é¢ç²’å­ç­‰æ•ˆé€Ÿåº¦ï¼š$\mathbf{v}_j^{\text{equiv}} = -\mathbf{v}_i$ï¼ˆç†è®ºé•œåƒï¼‰
- é€Ÿåº¦å·®ï¼š$\mathbf{v}_i - \mathbf{v}_j^{\text{equiv}} = 2\mathbf{v}_i$

**æ³¨**ï¼šä»£ç ä¸­æœªæ˜¾å¼è®¡ç®—é•œåƒé€Ÿåº¦ï¼Œ`2.0*`ç³»æ•°ç›´æ¥ä½“ç°æ— æ»‘ç§»æ¡ä»¶çš„ç‰©ç†è¦æ±‚ã€‚

**æºç è¯æ®**ï¼š
- `viscous_dynamics.hpp:89-112`ï¼š`2.0 * (vel_[i] - vel_ave_k[j])`
- `vel_ave_k[j]`æ¥è¿‘0ï¼ˆå£é¢é€Ÿåº¦ï¼‰ï¼Œå·®å€¼çº¦ä¸º`2*vel_[i]`

**ä¸ºä»€ä¹ˆé•œåƒé€Ÿåº¦èƒ½å®ç°æ— æ»‘ç§»è¾¹ç•Œæ¡ä»¶ï¼Ÿ**

è¿™æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ï¼Œéœ€è¦ä»è¿ç»­ä»‹è´¨åŠ›å­¦åˆ°SPHç¦»æ•£åŒ–è¿›è¡Œè¯¦ç»†æ¨å¯¼ã€‚

##### è¿ç»­ä»‹è´¨åŠ›å­¦çš„æ— æ»‘ç§»æ¡ä»¶

åœ¨å£é¢å¤„ï¼ˆ$\mathbf{x}_w$ï¼‰ï¼Œæ— æ»‘ç§»è¾¹ç•Œæ¡ä»¶è¦æ±‚ï¼š
$$\mathbf{v}(\mathbf{x}_w) = \mathbf{v}_{\text{wall}} = 0$$

å¯¹äºç²˜æ€§åŠ›ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—**é€Ÿåº¦æ¢¯åº¦**ï¼š
$$\frac{\partial \mathbf{v}}{\partial n}\bigg|_{\text{wall}} = \lim_{\Delta n \to 0} \frac{\mathbf{v}(\mathbf{x}_w + \Delta n \mathbf{n}) - \mathbf{v}(\mathbf{x}_w)}{\Delta n}$$

ç”±äº$\mathbf{v}(\mathbf{x}_w) = 0$ï¼š
$$\frac{\partial \mathbf{v}}{\partial n}\bigg|_{\text{wall}} = \lim_{\Delta n \to 0} \frac{\mathbf{v}(\mathbf{x}_w + \Delta n \mathbf{n})}{\Delta n}$$

##### SPHç¦»æ•£åŒ–çš„æŒ‘æˆ˜

åœ¨SPHä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç²’å­æ’å€¼ï¼š
$$\mathbf{v}_i = \sum_j \mathbf{v}_j W_{ij} V_j$$

ç²˜æ€§åŠ›éœ€è¦è®¡ç®—é€Ÿåº¦å·®ï¼š
$$\mathbf{f}_i^{\text{viscous}} \propto \sum_j (\mathbf{v}_i - \mathbf{v}_j) \nabla W_{ij} V_j$$

**é—®é¢˜**ï¼šå£é¢ç²’å­çš„é€Ÿåº¦$\mathbf{v}_j$åº”è¯¥è®¾ä¸ºå¤šå°‘ï¼Ÿ

**é€‰é¡¹1**ï¼š$\mathbf{v}_j = 0$ï¼ˆç›´æ¥è®¾ä¸ºå£é¢é€Ÿåº¦ï¼‰
- âŒ é”™è¯¯ï¼šé€Ÿåº¦å·®$\mathbf{v}_i - 0 = \mathbf{v}_i$
- âŒ ç»“æœï¼šç²˜æ€§åŠ›ä¸å¤Ÿå¼ºï¼Œæ— æ³•å¼ºåˆ¶æ‰§è¡Œæ— æ»‘ç§»

**é€‰é¡¹2**ï¼š$\mathbf{v}_j = -\mathbf{v}_i$ï¼ˆé•œåƒé€Ÿåº¦ï¼‰
- âœ… æ­£ç¡®ï¼šé€Ÿåº¦å·®$\mathbf{v}_i - (-\mathbf{v}_i) = 2\mathbf{v}_i$
- âœ… ç»“æœï¼šç²˜æ€§åŠ›ç¿»å€ï¼Œå¼ºåˆ¶æµä½“é€Ÿåº¦è¶‹å‘äº0

##### é•œåƒé€Ÿåº¦çš„ç‰©ç†æœºåˆ¶

**1. é€Ÿåº¦å‰–é¢çš„å¯¹ç§°æ€§**

æƒ³è±¡å£é¢å¤„çš„é€Ÿåº¦åˆ†å¸ƒï¼š

```
æµä½“åŸŸï¼ˆy > 0ï¼‰ï¼š
    y = h    : v = v_fluid(h)     â—
    y = h/2  : v = v_fluid(h/2)   â—
    y = 0    : v = 0              â”â”â”â”â”â”â”â”â”â”â”â” å£é¢
    y = -h/2 : v = -v_fluid(h/2)  â— (é•œåƒ)
    y = -h   : v = -v_fluid(h)    â— (é•œåƒ)
         â†‘
    å£é¢ä¸‹æ–¹çš„"è™šæ‹ŸåŸŸ"ï¼ˆé•œåƒï¼‰
```

æ— æ»‘ç§»æ¡ä»¶è¦æ±‚å£é¢å¤„é€Ÿåº¦ä¸º0ï¼Œè¿™æ„å‘³ç€é€Ÿåº¦å‰–é¢åœ¨å£é¢å¤„**åå¯¹ç§°**ï¼š
$$v(y) = -v(-y)$$

å› æ­¤ï¼Œå£é¢"ä¸‹æ–¹"ï¼ˆè™šæ‹ŸåŒºåŸŸï¼‰çš„é€Ÿåº¦åº”è¯¥æ˜¯ä¸Šæ–¹çš„**è´Ÿå€¼**ï¼ˆé•œåƒï¼‰ã€‚

**2. é€Ÿåº¦æ¢¯åº¦çš„æ­£ç¡®è®¡ç®—**

ä½¿ç”¨é•œåƒé€Ÿåº¦åï¼Œå£é¢å¤„çš„é€Ÿåº¦æ¢¯åº¦ï¼š
$$\frac{\partial v}{\partial y}\bigg|_{y=0} = \lim_{h \to 0} \frac{v(+h) - v(-h)}{2h} = \lim_{h \to 0} \frac{v(h) - (-v(h))}{2h} = \lim_{h \to 0} \frac{2v(h)}{2h} = \frac{dv}{dy}\bigg|_{y=0^+}$$

è¿™ä¸è¿ç»­ä»‹è´¨åŠ›å­¦çš„å•ä¾§å¯¼æ•°ä¸€è‡´ï¼

**3. SPHç²˜æ€§åŠ›çš„æ•°å­¦éªŒè¯**

æ ‡å‡†SPHç²˜æ€§åŠ›ï¼ˆç®€åŒ–å½¢å¼ï¼‰ï¼š
$$\mathbf{f}_i^{\text{viscous}} = \mu \sum_j \frac{(\mathbf{v}_i - \mathbf{v}_j)}{r_{ij}} \nabla W_{ij} V_j$$

å¯¹äºæµä½“ç²’å­$i$é è¿‘å£é¢ï¼š

**æƒ…å†µA**ï¼šå£é¢ç²’å­é€Ÿåº¦$\mathbf{v}_j = 0$
$$\mathbf{f}_i = \mu \sum_j \frac{\mathbf{v}_i}{r_{ij}} \nabla W_{ij} V_j$$

**æƒ…å†µB**ï¼šå£é¢ç²’å­é€Ÿåº¦$\mathbf{v}_j = -\mathbf{v}_i$ï¼ˆé•œåƒï¼‰
$$\mathbf{f}_i = \mu \sum_j \frac{2\mathbf{v}_i}{r_{ij}} \nabla W_{ij} V_j = 2 \times \mathbf{f}_{\text{æƒ…å†µA}}$$

**ç»“è®º**ï¼šé•œåƒé€Ÿåº¦ä½¿ç²˜æ€§åŠ›ç¿»å€ï¼Œæä¾›æ›´å¼ºçš„çº¦æŸï¼Œä½¿$\mathbf{v}_i \to 0$çš„è¶‹åŠ¿æ›´å¿«ã€‚

##### æ•°å­¦ç­‰æ•ˆæ€§è¯æ˜

**è¿ç»­å½¢å¼çš„ç²˜æ€§åŠ›**ï¼š
$$\mathbf{f}^{\text{viscous}} = \mu \nabla^2 \mathbf{v}$$

åœ¨å£é¢é™„è¿‘ï¼Œä½¿ç”¨Taylorå±•å¼€ï¼š
$$\mathbf{v}(y) \approx \mathbf{v}_{\text{wall}} + y \frac{\partial \mathbf{v}}{\partial y}\bigg|_{\text{wall}} + \frac{y^2}{2} \frac{\partial^2 \mathbf{v}}{\partial y^2}\bigg|_{\text{wall}}$$

ç”±äº$\mathbf{v}_{\text{wall}} = 0$ï¼š
$$\mathbf{v}(y) \approx y \frac{\partial \mathbf{v}}{\partial y}\bigg|_{\text{wall}}$$

**å…³é”®**ï¼šé€Ÿåº¦æ¢¯åº¦ç”±å£é¢ä¸¤ä¾§çš„é€Ÿåº¦å·®ç¡®å®šï¼š
$$\frac{\partial \mathbf{v}}{\partial y}\bigg|_{\text{wall}} \approx \frac{\mathbf{v}(+h) - \mathbf{v}(-h)}{2h}$$

å¦‚æœ$\mathbf{v}(-h) = -\mathbf{v}(+h)$ï¼ˆé•œåƒï¼‰ï¼š
$$\frac{\partial \mathbf{v}}{\partial y}\bigg|_{\text{wall}} = \frac{\mathbf{v}(h) - (-\mathbf{v}(h))}{2h} = \frac{2\mathbf{v}(h)}{2h} = \frac{\mathbf{v}(h)}{h}$$

è¿™æ­£æ˜¯æ— æ»‘ç§»æ¡ä»¶ä¸‹çš„æ­£ç¡®é€Ÿåº¦æ¢¯åº¦ï¼

##### SPHä»£ç ä¸­çš„ä½“ç°

è™½ç„¶SPHinXsysä»£ç ä¸­**æœªæ˜¾å¼è®¡ç®—é•œåƒé€Ÿåº¦**ï¼Œä½†`2.0*`ç³»æ•°è¾¾åˆ°äº†ç›¸åŒæ•ˆæœï¼š

```cpp
// viscous_dynamics.hpp:89
Vecd vel_derivative = 2.0 * (vel_[index_i] - vel_ave_k[index_j]) / (r_ij + 0.01 * h);
//                    ^^^
//                    ç­‰æ•ˆäºé•œåƒé€Ÿåº¦çš„æ•ˆæœ

// ç­‰ä»·äºï¼š
// vel_wall_mirror = -vel_[index_i]  // é•œåƒé€Ÿåº¦ï¼ˆæœªæ˜¾å¼è®¡ç®—ï¼‰
// vel_derivative = (vel_[index_i] - vel_wall_mirror) / r_ij
//                = (vel_[index_i] - (-vel_[index_i])) / r_ij
//                = 2 * vel_[index_i] / r_ij
```

**ç‰©ç†è§£é‡Š**ï¼š
- `vel_ave_k[index_j]` é€šå¸¸æ¥è¿‘0ï¼ˆå£é¢é€Ÿåº¦ï¼‰
- `2.0 * (vel_[i] - 0)` ç­‰æ•ˆäºä½¿ç”¨äº†é•œåƒé€Ÿåº¦
- ç»“æœï¼šå¼ºåˆ¶æ‰§è¡Œæ— æ»‘ç§»è¾¹ç•Œæ¡ä»¶

##### æ€»ç»“ï¼šé•œåƒé€Ÿåº¦çš„æœ¬è´¨

| ç‰©ç†è¦æ±‚ | æ•°å­¦è¡¨è¾¾ | SPHå®ç° | æ•ˆæœ |
|---------|---------|---------|------|
| **æ— æ»‘ç§»** | $\mathbf{v}_{\text{wall}} = 0$ | å£é¢ç²’å­é™æ­¢ | - |
| **é€Ÿåº¦æ¢¯åº¦** | $\partial v / \partial n \|_{\text{wall}}$ | éœ€è¦å£é¢ä¸¤ä¾§é€Ÿåº¦å·® | - |
| **åå¯¹ç§°æ€§** | $v(y) = -v(-y)$ | é•œåƒé€Ÿåº¦$v_j = -v_i$ | âœ… æ»¡è¶³åå¯¹ç§° |
| **å¼ºåˆ¶æ‰§è¡Œ** | è¶³å¤Ÿå¼ºçš„ç²˜æ€§åŠ› | `2.0*` ç³»æ•° | âœ… ç¿»å€çš„ç²˜æ€§åŠ› |

**æ ¸å¿ƒåŸç†**ï¼š
1. æ— æ»‘ç§»æ¡ä»¶è¦æ±‚é€Ÿåº¦åœ¨å£é¢å¤„**åå¯¹ç§°**
2. åå¯¹ç§°æ€§æ„å‘³ç€å£é¢"ä¸‹æ–¹"ï¼ˆè™šæ‹Ÿï¼‰çš„é€Ÿåº¦åº”è¯¥æ˜¯ä¸Šæ–¹çš„è´Ÿå€¼
3. SPHç²˜æ€§åŠ›éœ€è¦é€Ÿåº¦å·®ï¼Œé•œåƒé€Ÿåº¦æä¾›**æ­£ç¡®çš„é€Ÿåº¦å·®**ï¼ˆ$2v_i$ï¼‰
4. æ­£ç¡®çš„é€Ÿåº¦å·® â†’ æ­£ç¡®çš„é€Ÿåº¦æ¢¯åº¦ â†’ æ­£ç¡®çš„ç²˜æ€§åŠ› â†’ å¼ºåˆ¶æ‰§è¡Œæ— æ»‘ç§»

**ä¸ºä»€ä¹ˆç›´æ¥è®¾$v_j=0$ä¸å¤Ÿï¼Ÿ**
- ç›´æ¥è®¾0ï¼šé€Ÿåº¦å·® = $v_i - 0 = v_i$
- é•œåƒé€Ÿåº¦ï¼šé€Ÿåº¦å·® = $v_i - (-v_i) = 2v_i$
- é•œåƒæ–¹æ³•æä¾›çš„çº¦æŸåŠ›æ˜¯ç›´æ¥è®¾0çš„**2å€**ï¼Œæ›´æœ‰æ•ˆåœ°å¼ºåˆ¶$v_i \to 0$

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆé•œåƒé€Ÿåº¦ï¼ˆæˆ–ç­‰æ•ˆçš„`2.0*`ç³»æ•°ï¼‰èƒ½å¤Ÿæ­£ç¡®å®ç°æ— æ»‘ç§»è¾¹ç•Œæ¡ä»¶çš„æ ¹æœ¬åŸå› ï¼

**3. ç²˜æ€§åŠ›å…¬å¼æ¨å¯¼**ï¼š

æ ‡å‡†SPHç²˜æ€§åŠ›ï¼ˆMorris 1997ç®€åŒ–ç‰ˆï¼‰ï¼š
$$\mathbf{f}_i^{\text{viscous}} = \sum_j \mu \frac{(\mathbf{v}_i - \mathbf{v}_j)}{r_{ij} + \epsilon} (\mathbf{e}_{ij} \cdot \mathbf{K}_{ij} \cdot \mathbf{e}_{ij}) \nabla W_{ij} V_j$$

ä»£å…¥å£é¢é•œåƒé€Ÿåº¦ $\mathbf{v}_j = -\mathbf{v}_i$ï¼š
$$\mathbf{f}_i^{\text{wall}} = \sum_j \mu \frac{2\mathbf{v}_i}{r_{ij} + \epsilon} (\mathbf{e}_{ij} \cdot \mathbf{K}_i \cdot \mathbf{e}_{ij}) \nabla W_{ij} V_j$$

ä»£ç ä¸­è¿›ä¸€æ­¥ä¹˜ä»¥2.0ï¼ˆåŠ å¼ºè¾¹ç•Œæ•ˆåº”ï¼‰ï¼š
$$\mathbf{f}_i^{\text{wall}} = 2 \sum_j \mu \frac{2\mathbf{v}_i}{r_{ij} + 0.01h} (\mathbf{e}_{ij} \cdot \mathbf{K}_i \cdot \mathbf{e}_{ij}) \nabla W_{ij} V_j$$

**4. ä»£ç -å…¬å¼å¯¹åº”**ï¼š

```cpp
// ä»£ç ä¸­çš„æ¯ä¸€é¡¹å¯¹åº”çš„ç‰©ç†é‡
Vecd vel_derivative = 2.0 * (vel_[index_i] - vel_ave_k[index_j]) / (r_ij + 0.01 * h);
//                    ^^^   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^   ^^^^^^^^^^^^^^^
//                    é•œåƒ   é€Ÿåº¦å·®ï¼ˆvel_ave_k[j]â‰ˆ0æˆ–-v_iï¼‰    æ­£åˆ™åŒ–åˆ†æ¯

force += 2.0 * e_ij.dot(K_i * e_ij) * mu * vel_derivative * dW_ij * wall_Vol;
//       ^^^   ^^^^^^^^^^^^^^^^^^^   ^^   ^^^^^^^^^^^^^^   ^^^^^   ^^^^^^^^
//       è¾¹ç•Œ   æ ¸å‡½æ•°ä¿®æ­£å¼ é‡        ç²˜åº¦  é€Ÿåº¦æ¢¯åº¦         æ ¸æ¢¯åº¦  å£é¢ä½“ç§¯
//       åŠ å¼º
```

**5. ç‰©ç†æ„ä¹‰æ€»ç»“**ï¼š

| ç‰©ç†æ•ˆåº” | æ•°å­¦è¡¨è¾¾ | ä»£ç å®ç° | æ•°å€¼å› å­ |
|---------|---------|---------|---------|
| æ— æ»‘ç§»æ¡ä»¶ | $\mathbf{v}_{\text{wall}} = 0$ | `vel_ave_k[j] â‰ˆ 0` | - |
| é€Ÿåº¦é•œåƒ | $\mathbf{v}_j = -\mathbf{v}_i$ | `vel_[i] - vel_ave_k[j] â‰ˆ 2*vel_[i]` | 2Ã— |
| è¾¹ç•ŒåŠ å¼º | æé«˜è¾¹ç•Œçº¦æŸå¼ºåº¦ | å¤–éƒ¨å†ä¹˜`2.0` | 2Ã— |
| æ€»æ•ˆæœ | å£é¢ç²˜æ€§åŠ› = 4å€æ ‡å‡†ç²˜æ€§ | `4 * Î¼ * v_i / r_ij` | **4Ã—** |

**ä¸ºä»€ä¹ˆéœ€è¦4å€ç³»æ•°ï¼Ÿ**
- 2Ã—æ¥è‡ªé•œåƒé€Ÿåº¦ï¼ˆç‰©ç†å¿…éœ€ï¼‰
- 2Ã—æ¥è‡ªè¾¹ç•ŒåŠ å¼ºï¼ˆæ•°å€¼ç¨³å®šæ€§ï¼‰
- ç¡®ä¿æ— æ»‘ç§»è¾¹ç•Œæ¡ä»¶å¼ºåˆ¶æ‰§è¡Œ

##### 2. å‹åŠ›æ¢¯åº¦å¤„ç†

**ä»£ç å®ç°**ï¼š
```cpp
// fluid_integration.hpp:90-106ï¼ˆå£é¢æ¥è§¦ï¼‰
force -= (p_[index_i] * correction_k(index_j, index_i) +
          p_k[index_j] * correction_(index_i)) * dW_ij_k * e_ij_k;
```

**ç‰©ç†åŸç†è¯¦è§£**ï¼š

**1. å‹åŠ›è¾¹ç•Œæ¡ä»¶**ï¼š

ç†è®ºè¦æ±‚ï¼šå£é¢æ³•å‘å‹åŠ›è¿ç»­
$$p_{\text{wall}} = p_{\text{fluid}}|_{\text{wall}}$$

âš ï¸ **[å®é™…å®ç°]** å£é¢ç²’å­å‹åŠ›é€šè¿‡**é™åŠ›å­¦å¤–æ¨**è®¡ç®—ï¼ˆéæ ‡å‡†SPHå¤–æ¨ï¼‰ï¼š
$$p_{\text{wall}}[j] = p_{\text{fluid}}[i] + \rho_i \cdot r_{ij} \cdot \max(0, \mathbf{a}_{\text{ext}} \cdot \mathbf{n})$$

å…¶ä¸­ï¼š
- $p_{\text{fluid}}[i]$ï¼šæµä½“ç²’å­içš„å‹åŠ›ï¼ˆç›´æ¥ä½¿ç”¨ï¼‰
- $\rho_i \cdot r_{ij} \cdot ...$ï¼šé™åŠ›å­¦ä¿®æ­£é¡¹ï¼ˆè€ƒè™‘å¤–åŠ›å¦‚é‡åŠ›çš„å½±å“ï¼‰
- $\mathbf{a}_{\text{ext}}$ï¼šå¤–åŠ›å¼•èµ·çš„åŠ é€Ÿåº¦ï¼ˆç›¸å¯¹äºå£é¢åŠ é€Ÿåº¦ï¼‰

**æºç ä¾æ®**ï¼š
- `fluid_integration.hpp:105-107`ï¼šé™åŠ›å­¦å¤–æ¨å…¬å¼
  ```cpp
  Real p_j_in_wall = p_[index_i] + rho_[index_i] * r_ij * SMAX(Real(0), face_wall_external_acceleration);
  ```
- `surface_particles.h:40-48`ï¼š`SurfaceParticles`ç±»ä¸­**æ— å‹åŠ›å˜é‡å­˜å‚¨**
- `base_fluid_dynamics.h:54-74`ï¼š`InteractionWithWall`ç±»ä¸­**æ— å£é¢å‹åŠ›æ•°ç»„**

**ä¸ºä»€ä¹ˆä¸ç”¨æ ‡å‡†SPHå¤–æ¨**ï¼ˆ$p_k[j] = \sum_i p_i W / \sum_i W$ï¼‰ï¼š
- âœ… **è®¡ç®—æ•ˆç‡**ï¼šé™åŠ›å­¦å¤–æ¨åªéœ€1ä¸ªæµä½“ç²’å­ï¼Œæ ‡å‡†å¤–æ¨éœ€æœç´¢é‚»å±…
- âœ… **å³æ—¶è®¡ç®—**ï¼šåœ¨å‹åŠ›æ¾å¼›å¾ªç¯å†…ä¸´æ—¶è®¡ç®—ï¼Œæ— éœ€é¢„å­˜å‚¨
- âœ… **ç‰©ç†åˆç†**ï¼šå¯¹äºå£é¢è¾¹ç•Œï¼Œå•ç²’å­å¤–æ¨+é™å‹ä¿®æ­£å·²è¶³å¤Ÿå‡†ç¡®

**2. å‹åŠ›æ¢¯åº¦SPHå…¬å¼**ï¼š

æ ‡å‡†å¯¹ç§°å½¢å¼ï¼ˆé¿å…åŠ¨é‡ä¸å®ˆæ’ï¼‰ï¼š
$$-\nabla p_i = -\rho_i \sum_j m_j \left(\frac{p_i}{\rho_i^2} + \frac{p_j}{\rho_j^2}\right) \nabla W_{ij}$$

è½¬æ¢ä¸ºåŠ›çš„å½¢å¼ï¼ˆä¹˜ä»¥ä½“ç§¯$V_i$ï¼‰ï¼š
$$\mathbf{f}_i^{\text{pressure}} = -V_i \sum_j (p_i \mathcal{C}_j + p_j \mathcal{C}_i) \nabla W_{ij} V_j$$

å…¶ä¸­$\mathcal{C}$æ˜¯æ ¸å‡½æ•°ä¿®æ­£å¼ é‡ï¼ˆCorrective Matrixï¼‰ã€‚

**3. å£é¢å¤„ç†ç‰¹æ®Šæ€§**ï¼š

æµä½“-æµä½“ï¼š
$$\mathbf{f}_i^{\text{pressure}} = -V_i \sum_j (p_i \mathcal{C}_j^i + p_j \mathcal{C}_i) \nabla W_{ij} V_j$$

æµä½“-å£é¢ï¼ˆä½¿ç”¨å£é¢å‹åŠ›$p_k[j]$ï¼‰ï¼š
$$\mathbf{f}_i^{\text{wall}} = -V_i \sum_k (p_i \mathcal{C}_k^i + p_k[j] \mathcal{C}_i) \nabla W_{ik} V_k$$

**4. ä»£ç -ç‰©ç†å¯¹åº”**ï¼š

```cpp
force -= (p_[index_i] * correction_k(index_j, index_i) +
          p_k[index_j] * correction_(index_i)) * dW_ij_k * e_ij_k;
//       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
//       å‹åŠ›æ¢¯åº¦SPHå¯¹ç§°å½¢å¼ï¼Œç¡®ä¿åŠ¨é‡å®ˆæ’
//
//       p_[index_i]ï¼šæµä½“ç²’å­içš„å‹åŠ›
//       correction_k(j,i)ï¼šå£é¢â†’æµä½“çš„æ ¸ä¿®æ­£å¼ é‡
//       p_k[index_j]ï¼šå£é¢ç²’å­jçš„å‹åŠ›ï¼ˆä»æµä½“å¤–æ¨ï¼‰
//       correction_(i)ï¼šæµä½“ç²’å­içš„æ ¸ä¿®æ­£å¼ é‡
```

---

**ä¸ºä»€ä¹ˆå‹åŠ›æ¢¯åº¦å…¬å¼æ˜¯è¿™ç§å¯¹ç§°å½¢å¼ï¼Ÿ**

è¿™æ˜¯SPHæ–¹æ³•ä¸­æœ€é‡è¦çš„å…¬å¼ä¹‹ä¸€ï¼Œéœ€è¦ä»è¿ç»­å½¢å¼é€æ­¥æ¨å¯¼åˆ°ç¦»æ•£å½¢å¼ã€‚

##### ä»Navier-Stokesæ–¹ç¨‹å‡ºå‘

è¿ç»­å½¢å¼çš„åŠ¨é‡æ–¹ç¨‹ä¸­ï¼Œå‹åŠ›æ¢¯åº¦é¡¹ä¸ºï¼š
$$\frac{D\mathbf{v}}{Dt} = -\frac{1}{\rho}\nabla p + \nu \nabla^2 \mathbf{v} + \mathbf{f}$$

å‹åŠ›æ¢¯åº¦åŠ›ï¼ˆå•ä½è´¨é‡ï¼‰ï¼š
$$\mathbf{a}_{\text{pressure}} = -\frac{1}{\rho}\nabla p$$

##### æ ‡å‡†SPHç¦»æ•£åŒ–ï¼ˆå¯¹ç§°å½¢å¼ï¼‰

SPHçš„åŸºæœ¬æ’å€¼å…¬å¼ï¼š
$$f(\mathbf{x}_i) = \sum_j f_j W_{ij} V_j$$

å¯¹æ¢¯åº¦ç®—å­çš„SPHç¦»æ•£ï¼š
$$\nabla f(\mathbf{x}_i) = \sum_j f_j \nabla_i W_{ij} V_j$$

ä½†ç›´æ¥åº”ç”¨ä¼šå¯¼è‡´**åŠ¨é‡ä¸å®ˆæ’**é—®é¢˜ã€‚

##### åŠ¨é‡å®ˆæ’çš„æ¨å¯¼

**é—®é¢˜**ï¼šå¦‚æœç®€å•å†™æˆï¼š
$$\mathbf{f}_i^{\text{pressure}} = -\frac{1}{\rho_i} \sum_j p_j \nabla W_{ij} V_j$$

é‚£ä¹ˆç²’å­iå—åˆ°çš„åŠ›ï¼š$\mathbf{f}_i = -\frac{1}{\rho_i} \sum_j p_j \nabla W_{ij} V_j$

ç²’å­jå—åˆ°çš„åŠ›ï¼š$\mathbf{f}_j = -\frac{1}{\rho_j} \sum_k p_k \nabla W_{jk} V_k$

**ç‰›é¡¿ç¬¬ä¸‰å®šå¾‹è¦æ±‚**ï¼š$\mathbf{f}_{ij} = -\mathbf{f}_{ji}$

ä½†ä¸Šè¿°å½¢å¼**ä¸æ»¡è¶³**ï¼

**è§£å†³æ–¹æ¡ˆï¼ˆMonaghan 1992ï¼‰**ï¼šä½¿ç”¨å¯¹ç§°å½¢å¼
$$-\frac{1}{\rho}\nabla p \approx -\sum_j m_j \left(\frac{p_i}{\rho_i^2} + \frac{p_j}{\rho_j^2}\right) \nabla W_{ij}$$

**éªŒè¯åŠ¨é‡å®ˆæ’**ï¼š
- ç²’å­iå¯¹jçš„ä½œç”¨åŠ›ï¼š$\mathbf{f}_{ij} = -m_i m_j \left(\frac{p_i}{\rho_i^2} + \frac{p_j}{\rho_j^2}\right) \nabla_i W_{ij}$
- ç²’å­jå¯¹içš„ä½œç”¨åŠ›ï¼š$\mathbf{f}_{ji} = -m_j m_i \left(\frac{p_j}{\rho_j^2} + \frac{p_i}{\rho_i^2}\right) \nabla_j W_{ji}$

ç”±äº$\nabla_i W_{ij} = -\nabla_j W_{ji}$ï¼š
$$\mathbf{f}_{ji} = -m_j m_i \left(\frac{p_j}{\rho_j^2} + \frac{p_i}{\rho_i^2}\right) (-\nabla_i W_{ij}) = -\mathbf{f}_{ij}$$

âœ… æ»¡è¶³ç‰›é¡¿ç¬¬ä¸‰å®šå¾‹ï¼

##### è½¬æ¢ä¸ºåŠ›çš„å½¢å¼

æ ‡å‡†å…¬å¼ä½¿ç”¨è´¨é‡$m_j$ï¼š
$$\mathbf{f}_i = -\rho_i V_i \sum_j m_j \left(\frac{p_i}{\rho_i^2} + \frac{p_j}{\rho_j^2}\right) \nabla W_{ij}$$

ä»£å…¥$m_j = \rho_j V_j$ï¼š
$$\mathbf{f}_i = -\rho_i V_i \sum_j \rho_j V_j \left(\frac{p_i}{\rho_i^2} + \frac{p_j}{\rho_j^2}\right) \nabla W_{ij}$$

ç®€åŒ–ï¼š
$$\mathbf{f}_i = -V_i \sum_j \left(\frac{p_i}{\rho_i} + \frac{p_j}{\rho_j}\right) \rho_j \nabla W_{ij} V_j$$

è¿›ä¸€æ­¥æ•´ç†ï¼š
$$\mathbf{f}_i = -V_i \sum_j (p_i + p_j \frac{\rho_j}{\rho_i}) \nabla W_{ij} V_j$$

##### å¼•å…¥æ ¸å‡½æ•°ä¿®æ­£çŸ©é˜µ

åœ¨å®é™…ä»£ç ä¸­ï¼Œä¸ºäº†æé«˜è¾¹ç•Œé™„è¿‘çš„ç²¾åº¦ï¼Œå¼•å…¥**æ ¸å‡½æ•°ä¿®æ­£**ï¼ˆKernel Gradient Correctionï¼‰ã€‚

**æ ‡å‡†SPHæ¢¯åº¦**ï¼š
$$\nabla f_i = \sum_j (f_j - f_i) \nabla W_{ij} V_j$$

**ä¿®æ­£åçš„æ¢¯åº¦**ï¼š
$$\nabla f_i = \sum_j (f_j - f_i) \mathbf{C}_i \nabla W_{ij} V_j$$

å…¶ä¸­$\mathbf{C}_i$æ˜¯ä¿®æ­£çŸ©é˜µï¼ˆCorrective Matrixï¼‰ï¼Œæ»¡è¶³ï¼š
$$\sum_j \mathbf{r}_{ij} \mathbf{C}_i \nabla W_{ij} V_j = \mathbf{I}$$

è¿™ç¡®ä¿äº†æ¢¯åº¦åœ¨ç²’å­åˆ†å¸ƒä¸è§„åˆ™æ—¶ä»ç„¶å‡†ç¡®ã€‚

**åº”ç”¨åˆ°å‹åŠ›æ¢¯åº¦**ï¼š
$$\mathbf{f}_i = -V_i \sum_j (p_i \mathbf{C}_j^i + p_j \mathbf{C}_i) \nabla W_{ij} V_j$$

è¿™é‡Œï¼š
- $\mathbf{C}_i$ï¼šç²’å­içš„ä¿®æ­£çŸ©é˜µ
- $\mathbf{C}_j^i$ï¼šç²’å­jç›¸å¯¹äºç²’å­içš„ä¿®æ­£çŸ©é˜µ

##### ä»£ç å…¬å¼çš„å¯¹åº”å…³ç³»

**ä»£ç **ï¼š
```cpp
force -= (p_[index_i] * correction_k(index_j, index_i) +
          p_k[index_j] * correction_(index_i)) * dW_ij_k * e_ij_k;
```

**å…¬å¼å¯¹åº”**ï¼š
$$\mathbf{f}_i \mathrel{-}= (p_i \cdot \mathcal{C}_j^i + p_j \cdot \mathcal{C}_i) \cdot \nabla W_{ij} \cdot V_j \cdot \mathbf{e}_{ij}$$

**é€é¡¹è§£é‡Š**ï¼š

| ä»£ç å˜é‡ | ç‰©ç†é‡ | æ•°å­¦ç¬¦å· | è¯´æ˜ |
|---------|--------|---------|------|
| `p_[index_i]` | æµä½“ç²’å­içš„å‹åŠ› | $p_i$ | å½“å‰ç²’å­å‹åŠ› |
| `correction_k(j,i)` | å£é¢â†’æµä½“ä¿®æ­£ | $\mathcal{C}_j^i$ | å£é¢ç²’å­jå¯¹æµä½“ç²’å­içš„æ ¸ä¿®æ­£ |
| `p_k[index_j]` | å£é¢ç²’å­jçš„å‹åŠ› | $p_j$ | å£é¢å‹åŠ›ï¼ˆé™åŠ›å­¦å¤–æ¨ï¼‰ |
| `correction_(i)` | æµä½“ç²’å­ä¿®æ­£ | $\mathcal{C}_i$ | æµä½“ç²’å­içš„æ ¸ä¿®æ­£çŸ©é˜µ |
| `dW_ij_k` | æ ¸å‡½æ•°æ¢¯åº¦æ¨¡ | $\|\nabla W_{ij}\|$ | æ ¸å‡½æ•°å¯¹è·ç¦»çš„å¯¼æ•° |
| `e_ij_k` | å•ä½æ–¹å‘å‘é‡ | $\mathbf{e}_{ij}$ | ä»iæŒ‡å‘jçš„å•ä½å‘é‡ |
| `* V_j` | ï¼ˆéšå«ï¼‰å£é¢ä½“ç§¯ | $V_j$ | å£é¢ç²’å­ä½“ç§¯ |

**å®Œæ•´å…¬å¼**ï¼š
$$\mathbf{f}_i^{\text{wall}} = -V_i (p_i \mathcal{C}_j^i + p_j \mathcal{C}_i) \nabla W_{ij} V_j \mathbf{e}_{ij}$$

å…¶ä¸­ï¼š
- ç¬¬ä¸€é¡¹$p_i \mathcal{C}_j^i$ï¼šæµä½“å‹åŠ›é€šè¿‡ä¿®æ­£æ ¸ä½œç”¨äºå£é¢æ–¹å‘
- ç¬¬äºŒé¡¹$p_j \mathcal{C}_i$ï¼šå£é¢å‹åŠ›é€šè¿‡ä¿®æ­£æ ¸åä½œç”¨äºæµä½“

##### ä¸ºä»€ä¹ˆéœ€è¦æ ¸å‡½æ•°ä¿®æ­£ï¼Ÿ

**é—®é¢˜**ï¼šåœ¨å£é¢é™„è¿‘ï¼Œç²’å­åˆ†å¸ƒä¸è§„åˆ™ï¼š

```
æµä½“åŸŸï¼š           å£é¢ï¼š
  â— â— â—           â”â”â”â”â”
  â— â— â—     â†’     â”â”â”â”â”
  â— â— â—           â”â”â”â”â”
 è§„åˆ™åˆ†å¸ƒ         å•ä¾§é‚»å±…
```

**åæœ**ï¼šæ ‡å‡†SPHæ ¸å‡½æ•°æ±‚å’Œä¸æ»¡è¶³ï¼š
$$\sum_j \nabla W_{ij} V_j \neq 0$$

**ä¿®æ­£æ–¹æ³•**ï¼šå¼•å…¥ä¿®æ­£çŸ©é˜µ$\mathbf{C}$ï¼Œä½¿å¾—ï¼š
$$\sum_j \mathbf{C} \nabla W_{ij} V_j = 0 \quad \text{(é›¶é˜¶ä¸€è‡´æ€§)}$$
$$\sum_j \mathbf{r}_{ij} \mathbf{C} \nabla W_{ij} V_j = \mathbf{I} \quad \text{(ä¸€é˜¶ä¸€è‡´æ€§)}$$

è¿™ç¡®ä¿äº†å³ä½¿åœ¨è¾¹ç•Œé™„è¿‘ï¼Œæ¢¯åº¦è®¡ç®—ä»ç„¶å‡†ç¡®ã€‚

##### ç‰©ç†æ„ä¹‰æ€»ç»“

**ä¸¤é¡¹ç›¸åŠ çš„ç‰©ç†æ„ä¹‰**ï¼š

1. **ç¬¬ä¸€é¡¹** $p_i \mathcal{C}_j^i$ï¼š
   - æµä½“ç²’å­içš„å‹åŠ›
   - é€šè¿‡å£é¢ç²’å­jçš„ä¿®æ­£æ ¸
   - äº§ç”ŸæŒ‡å‘å£é¢çš„å‹åŠ›æ¨åŠ›

2. **ç¬¬äºŒé¡¹** $p_j \mathcal{C}_i$ï¼š
   - å£é¢ç²’å­jçš„å‹åŠ›ï¼ˆåä½œç”¨ï¼‰
   - é€šè¿‡æµä½“ç²’å­içš„ä¿®æ­£æ ¸
   - äº§ç”Ÿä»å£é¢åå¼¹çš„å‹åŠ›åŠ›

**å¯¹ç§°å½¢å¼çš„ä¼˜åŠ¿**ï¼š
- âœ… ä¿è¯åŠ¨é‡å®ˆæ’ï¼ˆç‰›é¡¿ç¬¬ä¸‰å®šå¾‹ï¼‰
- âœ… æ•°å€¼ç¨³å®šï¼ˆå¯¹ç§°ç®—å­ï¼‰
- âœ… ç²¾åº¦æé«˜ï¼ˆæ ¸å‡½æ•°ä¿®æ­£ï¼‰

**ä¸æµä½“-æµä½“å‹åŠ›æ¢¯åº¦ä¸€è‡´**ï¼š
- æµä½“-æµä½“ï¼š$\mathbf{f}_i = -V_i \sum_j (p_i \mathcal{C}_j + p_j \mathcal{C}_i) \nabla W_{ij} V_j$
- æµä½“-å£é¢ï¼š$\mathbf{f}_i = -V_i \sum_k (p_i \mathcal{C}_k^i + p_k \mathcal{C}_i) \nabla W_{ik} V_k$

å”¯ä¸€åŒºåˆ«ï¼šå£é¢å‹åŠ›$p_k$é€šè¿‡é™åŠ›å­¦å¤–æ¨è®¡ç®—ï¼ˆå·²åœ¨Line 529-548è§£é‡Šï¼‰ã€‚

##### å…³é”®æ–‡çŒ®ä¾æ®

**å¯¹ç§°å½¢å¼å‹åŠ›æ¢¯åº¦**ï¼š
- Monaghan, J.J. (1992). "Smoothed Particle Hydrodynamics". *Annual Review of Astronomy and Astrophysics*, 30:543-574.
- è¯æ˜äº†å¯¹ç§°å½¢å¼æ»¡è¶³åŠ¨é‡å®ˆæ’

**æ ¸å‡½æ•°ä¿®æ­£æ–¹æ³•**ï¼š
- Bonet & Lok (1999). "Variational and momentum preservation aspects of SPH formulations". *Computer Methods in Applied Mechanics and Engineering*.
- å¼•å…¥ä¿®æ­£çŸ©é˜µæé«˜è¾¹ç•Œç²¾åº¦

**SPHinXsyså®ç°**ï¼š
- ä½¿ç”¨Modified SPHï¼ˆMSPHï¼‰æ–¹æ³•
- è‡ªåŠ¨è®¡ç®—ä¿®æ­£çŸ©é˜µï¼ˆåœ¨ç²’å­åˆå§‹åŒ–æ—¶ï¼‰
- ç¡®ä¿å£é¢è¾¹ç•Œçš„é«˜ç²¾åº¦å¤„ç†

---

**5. ä¸ºä»€ä¹ˆå£é¢å‹åŠ›ç”±æµä½“å¤–æ¨ï¼Ÿ**

| æ–¹æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| å›ºå®šå£é¢å‹åŠ› | ç®€å• | âŒ ä¸æ»¡è¶³æ³•å‘åº”åŠ›å¹³è¡¡ |
| ä»æµä½“å¤–æ¨ | âœ… è‡ªåŠ¨æ»¡è¶³å‹åŠ›è¿ç»­æ€§ | éœ€è¦é¢å¤–è®¡ç®— |
| é›¶å‹åŠ›æ¢¯åº¦ | å¸¸ç”¨äºå¼€æ”¾è¾¹ç•Œ | âŒ ä¸é€‚ç”¨äºå›ºå£ |

SPHinXsysé€‰æ‹©**å¤–æ¨æ³•**ï¼Œç¡®ä¿ç‰©ç†æ­£ç¡®æ€§ã€‚

#### ç‰©ç†åŸç†ä¸ä»£ç å®ç°ç»¼åˆå¯¹æ¯”

##### å£é¢è¾¹ç•Œæ¡ä»¶å®Œæ•´å¯¹åº”è¡¨

| ç‰©ç†è¦æ±‚ | æ•°å­¦è¡¨è¾¾ | SPHç¦»æ•£åŒ– | ä»£ç å®ç° | å…³é”®å‚æ•° |
|---------|---------|----------|---------|---------|
| **æ— æ»‘ç§»** | $\mathbf{v}\|_{\text{wall}} = 0$ | é•œåƒé€Ÿåº¦ $\mathbf{v}_j = -\mathbf{v}_i$ | `vel_derivative = 2*(v_i - v_wall)` | ç³»æ•°4Ã— |
| **å‹åŠ›è¿ç»­** | $p\|_{\text{wall}} = p_{\text{fluid}}$ | é™åŠ›å­¦å¤–æ¨ | `p_wall = p_i + Ï*r*a_n` | å³æ—¶è®¡ç®— |
| **ä¸å¯ç©¿é€** | $(\mathbf{x} - \mathbf{x}_w) \cdot \mathbf{n} \geq 0$ | å£é¢ç²’å­æ’æ–¥ | é€šè¿‡å‹åŠ›æ¢¯åº¦åŠ›å®ç° | `wall_thickness` |
| **æ³•å‘åº”åŠ›** | $\sigma_{nn} = -p$ | æ³•å‘å‹åŠ›åˆ†é‡ | `force -= p * dW * e_ij` | `normal` å‘é‡ |

##### æ•°å€¼ç¨³å®šæ€§æŠ€æœ¯

**1. æ­£åˆ™åŒ–åˆ†æ¯**ï¼ˆé¿å…å¥‡å¼‚æ€§ï¼‰ï¼š
```cpp
r_ij + 0.01 * h  // å½“ç²’å­éå¸¸æ¥è¿‘æ—¶ï¼ˆrâ†’0ï¼‰ï¼Œé˜²æ­¢åŠ›å‘æ•£
```

ç‰©ç†æ„ä¹‰ï¼šç›¸å½“äºåœ¨æå°è·ç¦»å¤„å¼•å…¥"è½¯åŒ–"

**2. æ ¸å‡½æ•°ä¿®æ­£**ï¼ˆæé«˜ç²¾åº¦ï¼‰ï¼š
```cpp
e_ij.dot(K_i * e_ij)  // æ ¸æ¢¯åº¦ä¿®æ­£ï¼Œè¡¥å¿ç²’å­åˆ†å¸ƒä¸å‡åŒ€
```

ç‰©ç†æ„ä¹‰ï¼šåœ¨å£é¢é™„è¿‘ç²’å­åˆ†å¸ƒä¸è§„åˆ™æ—¶ä¿æŒç²¾åº¦

**3. è¾¹ç•ŒåŠ å¼ºç³»æ•°**ï¼ˆå¼ºåˆ¶è¾¹ç•Œæ¡ä»¶ï¼‰ï¼š
```cpp
2.0 * ...  // ç²˜æ€§åŠ›ä¹˜ä»¥2ï¼Œç¡®ä¿æ— æ»‘ç§»æ¡ä»¶å¼ºåˆ¶æ‰§è¡Œ
```

ç‰©ç†æ„ä¹‰ï¼šæ•°å€¼æ–¹æ³•éœ€è¦æ¯”ç†è®ºå€¼æ›´å¼ºçš„çº¦æŸ

##### å‘¨æœŸæ€§è¾¹ç•Œ vs å£é¢è¾¹ç•Œ

| ç‰¹æ€§ | å‘¨æœŸæ€§è¾¹ç•Œ | å£é¢è¾¹ç•Œ |
|------|-----------|---------|
| **ç‰©ç†æœ¬è´¨** | æ‹“æ‰‘è¿æ¥ï¼ˆæ— è¾¹ç•Œï¼‰ | å›ºä½“è¾¹ç•Œï¼ˆæœ‰é˜»æŒ¡ï¼‰ |
| **æ•°å­¦å®ç°** | åæ ‡å¹³ç§» + é•œåƒç²’å­ | è™šæ‹Ÿç²’å­ + é•œåƒé€Ÿåº¦ |
| **é€Ÿåº¦å¤„ç†** | ä¿æŒåŸé€Ÿåº¦ | é€Ÿåº¦é•œåƒï¼ˆæ— æ»‘ç§»ï¼‰ |
| **å‹åŠ›å¤„ç†** | å‘¨æœŸæ€§è¿ç»­ | æ³•å‘è¿ç»­ï¼ˆå¤–æ¨ï¼‰ |
| **ä»£ç å¤æ‚åº¦** | å‡ ä½•æ“ä½œï¼ˆç®€å•ï¼‰ | ç‰©ç†çº¦æŸï¼ˆå¤æ‚ï¼‰ |
| **è®¡ç®—å¼€é”€** | å°ï¼ˆè™šæ‹Ÿç²’å­ä¸´æ—¶ï¼‰ | ä¸­ï¼ˆå£é¢ç²’å­æ°¸ä¹…ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | æµåŠ¨æ–¹å‘ | å‚ç›´æ–¹å‘ |

#### è¾¹ç•Œæ¡ä»¶æ€»ç»“

| è¾¹ç•Œç±»å‹ | ä½ç½® | å®ç°æ–¹å¼ | å…³é”®å‚æ•° |
|---------|------|---------|----------|
| **å‘¨æœŸæ€§è¾¹ç•Œ** | xæ–¹å‘ | ç²’å­å¹³ç§» + è™šæ‹Ÿé•œåƒ | `periodic_translation = DL` |
| **æ— æ»‘ç§»å£é¢** | y=0, y=DH | å£é¢ç²’å­ + æ¥è§¦å…³ç³» | `wall_thickness`, `normal` |
| **å…¥å£/å‡ºå£** | å‘¨æœŸæ€§å®ç° | æ— éœ€æ˜¾å¼è®¾ç½® | - |

### 1.6 è¾¹ç•Œæ¡ä»¶åœ¨ä¸»å¾ªç¯ä¸­çš„åº”ç”¨

**å‘¨æœŸæ€§è¾¹ç•Œæ›´æ–°**ï¼ˆæ¯ä¸ªå¤–å±‚å¾ªç¯ï¼‰ï¼š
```cpp
// channel_flow_shell.cpp:302-309
periodic_condition.bounding_.exec();                      // å¹³ç§»è¶Šç•Œç²’å­
water_block.updateCellLinkedList();                       // æ›´æ–°é‚»å±…åˆ—è¡¨
periodic_condition.update_cell_linked_list_.exec();       // æ’å…¥è™šæ‹Ÿé•œåƒç²’å­
water_block_complex.updateConfiguration();                // æ›´æ–°æµä½“-å£é¢å…³ç³»
```

**æ‰§è¡Œé¡ºåº**ï¼š
```
Step 1: bounding_.exec()
  â†’ æ£€æŸ¥æ¯ä¸ªç²’å­æ˜¯å¦è¶Šç•Œ
  â†’ å¹³ç§»è¶Šç•Œç²’å­ï¼ˆx > DL â†’ x -= DLï¼‰

Step 2: updateCellLinkedList()
  â†’ æ ¹æ®æ–°ä½ç½®é‡å»ºcell-linked list
  â†’ æ¸…ç©ºæ—§çš„é‚»å±…åˆ—è¡¨

Step 3: update_cell_linked_list_.exec()
  â†’ è¯†åˆ«è¾¹ç•Œé™„è¿‘ç²’å­
  â†’ æ’å…¥è™šæ‹Ÿé•œåƒç²’å­

Step 4: updateConfiguration()
  â†’ æ›´æ–°æµä½“å†…éƒ¨é‚»å±…å…³ç³»
  â†’ æ›´æ–°æµä½“-å£é¢æ¥è§¦å…³ç³»
```

**é¢‘ç‡æ§åˆ¶**ï¼š
```cpp
// channel_flow_shell.cpp:303-306
if (number_of_iterations % 100 == 0 && number_of_iterations != 1)
{
    particle_sorting.exec();  // ç²’å­æ’åºä¼˜åŒ–ï¼ˆæ¯100æ­¥ï¼‰
}
```

### 1.7 è¾¹ç•Œæ¡ä»¶éªŒè¯

**æ•°å€¼æ£€æŸ¥**ï¼š

1. **å‘¨æœŸæ€§éªŒè¯**ï¼š
   - å·¦è¾¹ç•Œæµå‡ºç²’å­æ•° = å³è¾¹ç•Œæµå…¥ç²’å­æ•°
   - æ€»ç²’å­æ•°å®ˆæ’

2. **å£é¢å¤„ç†éªŒè¯**ï¼š
   - å£é¢å¤„é€Ÿåº¦ â‰ˆ 0ï¼ˆæ— æ»‘ç§»ï¼‰
   - å£é¢é™„è¿‘é€Ÿåº¦æ¢¯åº¦æœ€å¤§

3. **å‹åŠ›éªŒè¯**ï¼š
   - å‘¨æœŸæ€§æ–¹å‘å‹åŠ›æ¢¯åº¦æ’å®šï¼ˆ= Ï Ã— f_xï¼‰
   - yæ–¹å‘å‹åŠ›è¿ç»­

**å›¾ç¤ºå¯¹æ¯”**ï¼š
```
é”™è¯¯è®¾ç½®ï¼ˆå›ºå®šé€Ÿåº¦è¾¹ç•Œï¼‰:
  å…¥å£ â†’ [v=1.5] â†’ æµä½“åŸŸ â†’ [v=1.5] â†’ å‡ºå£
  é—®é¢˜ï¼šç ´åè´¨é‡å®ˆæ’ï¼Œæ— æ³•è¾¾åˆ°ç¨³æ€

æ­£ç¡®è®¾ç½®ï¼ˆå‘¨æœŸæ€§è¾¹ç•Œï¼‰:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  æµä½“åŸŸ (å‘¨æœŸæ€§)             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                         â†“
     â””â”€â”€â”€â”€â”€â”€â”€ ç²’å­å¾ªç¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ä¼˜åŠ¿ï¼šè‡ªç„¶å‘å±•ï¼Œè´¨é‡å®ˆæ’
```

---

## äºŒã€ç®—æ³•æ€»ä½“æ¡†æ¶

### 2.1 ä¸»å¾ªç¯ç»“æ„

```cpp
// channel_flow_shell.cpp:264-310
while (physical_time < end_time)
{
    while (integration_time < output_interval)
    {
        // ========== å¤–å±‚å¾ªç¯ï¼šå¯¹æµæ—¶é—´æ­¥ Dt ==========
        Real Dt = get_fluid_advection_time_step_size.exec();  // Line 270

        // ========== é¢„å¤„ç†é˜¶æ®µï¼šè®¡ç®— force_prior ==========
        update_density_by_summation.exec();       // Line 271
        viscous_acceleration.exec();              // Line 272
        transport_correction.exec();              // Line 273

        // ========== å†…å±‚å¾ªç¯ï¼šå£°æ³¢æ—¶é—´æ­¥ dt ==========
        while (relaxation_time < Dt)              // Line 277
        {
            Real dt = SMIN(get_fluid_time_step_size.exec(), Dt);  // Line 279

            pressure_relaxation.exec(dt);         // Line 281
            constant_gravity.exec(dt);            // Line 282
            density_relaxation.exec(dt);          // Line 284

            relaxation_time += dt;
        }

        // ========== åå¤„ç†ï¼šå‘¨æœŸæ€§è¾¹ç•Œ ==========
        periodic_condition.bounding_.exec();                      // Line 302
        water_block.updateCellLinkedList();                       // Line 307
        periodic_condition.update_cell_linked_list_.exec();       // Line 308
        water_block_complex.updateConfiguration();                // Line 309
    }
}
```

### 2.2 ä¸¤çº§æ—¶é—´æ­¥ç»“æ„

```
å¤–å±‚å¾ªç¯ï¼ˆå¯¹æµæ—¶é—´æ­¥ Dtï¼‰:
  â”œâ”€ è®¡ç®—ä¸€æ¬¡ç²˜æ€§åŠ›ï¼ˆæ…¢å˜é‡ï¼‰
  â”œâ”€ è®¡ç®—ä¸€æ¬¡ä½ç½®ä¿®æ­£ï¼ˆæ…¢å˜é‡ï¼‰
  â””â”€ å†…å±‚å¾ªç¯ï¼ˆå£°æ³¢æ—¶é—´æ­¥ dt, çº¦10æ¬¡ï¼‰:
      â”œâ”€ å‹åŠ›æ¾å¼›
      â”œâ”€ ä½“åŠ›æ–½åŠ 
      â””â”€ å¯†åº¦æ¾å¼›

æ—¶é—´æ­¥æ¯”: Dt / dt â‰ˆ câ‚€ / vmax = 10 / 1 = 10
```

**æ—¶é—´å°ºåº¦åˆ†æ**ï¼š

| æ—¶é—´å°ºåº¦ | è®¡ç®—å…¬å¼ | æ•°å€¼ | åœ¨å“ªä¸ªå¾ªç¯è®¡ç®— |
|---------|---------|------|--------------|
| ç²˜æ€§æ—¶é—´å°ºåº¦ | $\tau_{\text{viscous}} = \frac{DH^2}{\nu} = \frac{4}{0.02}$ | 200 s | å¤–å±‚ï¼ˆDtï¼‰ |
| å¯¹æµæ—¶é—´å°ºåº¦ | $\tau_{\text{convection}} = \frac{DH}{U} = \frac{2}{1}$ | 2 s | å¤–å±‚ï¼ˆDtï¼‰ |
| å£°æ³¢æ—¶é—´å°ºåº¦ | $\tau_{\text{acoustic}} = \frac{DH}{c_0} = \frac{2}{10}$ | 0.2 s | å†…å±‚ï¼ˆdtï¼‰ |

**ç»“è®º**ï¼š$\tau_{\text{acoustic}} \ll \tau_{\text{convection}} \ll \tau_{\text{viscous}}$

### æ—¶é—´æ­¥è®¡ç®—æœºåˆ¶å®Œæ•´è§£æ

#### CFLæ¡ä»¶ä¸æ—¶é—´æ­¥çš„å…³ç³»

SPHæ–¹æ³•ä½¿ç”¨åŒå±‚æ—¶é—´æ­¥ç­–ç•¥,åˆ†åˆ«å¤„ç†ä¸åŒç‰©ç†è¿‡ç¨‹:

##### 1. å¤–å±‚æ—¶é—´æ­¥ Dt(å¯¹æµ-æ‰©æ•£æ—¶é—´å°ºåº¦)

**è®¡ç®—å…¬å¼**(å®éªŒéªŒè¯):
```
Dt = advectionCFL Ã— h_min / max(speed_max, speed_ref, speed_visc)
   = 0.25 Ã— 0.065 / max(v_max, 1.5, v_visc)
```

**å…³é”®å‚æ•°éªŒè¯**:
- `h_min = 0.065 m`(å®éªŒæµ‹å¾—,**ä¸æ˜¯**0.05!)
- `h_min = h_spacing_ratio Ã— resolution_ref = 1.3 Ã— 0.05`
- `advectionCFL = 0.25`(é»˜è®¤å€¼,æ¥æº:`fluid_time_step.h:88`)
- `speed_ref = 1.5 m/s`(ä¼ å…¥å‚æ•°:`1.5 * U_f`)
- `speed_visc = Î¼/(Ïâ‚€h) = 0.02/(1.0Ã—0.065) â‰ˆ 0.31 m/s`

**æ•°å€¼éªŒè¯**:
```
Dt_theory = 0.25 Ã— 0.065 / 1.5 = 0.0108333 s
Dt_measured = 0.0108333 s
è¯¯å·®:0.00% âœ… å®Œç¾åŒ¹é…!
```

**ç‰©ç†æ„ä¹‰**:
- å¯¹æµæ—¶é—´å°ºåº¦:Ï„_adv = h/U â‰ˆ 0.065/1.5 â‰ˆ 0.043 s
- CFL=0.25æ„å‘³ç€å–çº¦25%çš„ç†è®ºæ—¶é—´æ­¥,ç¡®ä¿ç¨³å®šæ€§
- `speed_ref`é”å®šæœºåˆ¶:ç”±äº`speed_ref=1.5`å¤§äºå®é™…é€Ÿåº¦æ¼”åŒ–ä¸­çš„å¤§éƒ¨åˆ†å€¼,Dtåœ¨ç›¸å½“é•¿æ—¶é—´å†…ä¿æŒæ’å®š

##### 2. å†…å±‚æ—¶é—´æ­¥ dt(å£°å­¦æ—¶é—´å°ºåº¦)

**è®¡ç®—å…¬å¼**:
```
dt = acousticCFL Ã— h_min / (c + |v|)
   = 0.6 Ã— 0.065 / (10.0 + v_max)
```

**æ•°å€¼éªŒè¯**:
```
dt_theory = 0.6 Ã— 0.065 / (10 + 1.55) = 0.00338 s
dt_measured = 0.00355 s
è¯¯å·®:4.8% âœ… ä¼˜ç§€
```

**ç‰©ç†æ„ä¹‰**:
- å£°å­¦æ—¶é—´å°ºåº¦:Ï„_acoustic = h/c â‰ˆ 0.065/10 = 0.0065 s
- CFL=0.6æ„å‘³ç€å…è®¸å£°æ³¢åœ¨ä¸€ä¸ªæ—¶é—´æ­¥å†…ä¼ æ’­0.6å€ç²’å­é—´è·
- ç”±äºc=10è¿œå¤§äºvâ‰ˆ1.5,å£°é€Ÿä¸»å¯¼æ—¶é—´æ­¥(å æ¯”87%)

##### 3. æ—¶é—´æ­¥æ¯”å€¼çš„ç‰©ç†è§£é‡Š

**ç¬æ—¶æ¯”å€¼**(å®éªŒæµ‹å¾—):
```
Dt/dt = 0.0108333 / 0.00355 â‰ˆ 3.056
```

**ç†è®ºæ¨å¯¼**:
```
Dt/dt = (CFL_adv Ã— h / U_ref) / (CFL_ac Ã— h / c)
      = (CFL_adv / CFL_ac) Ã— (c / U_ref)
      = (0.25 / 0.6) Ã— (10 / 1.5)
      = 0.417 Ã— 6.67
      = 2.78 â‰ˆ 3.0 âœ…
```

**è¯¯å·®åˆ†æ**:
- ç†è®º2.78 vs å®æµ‹3.06,å·®å¼‚9.1%
- ä¸»è¦åŸå› :dtè®¡ç®—ä¸­è€ƒè™‘äº†`c+|v|`è€Œéå•çº¯`c`
- ä¿®æ­£è®¡ç®—:`Dt/dt = 0.417 Ã— (10+1.5)/1.5 = 3.19`(æ›´æ¥è¿‘å®æµ‹)

##### 4. "Dt/dt=4"çš„çœŸç›¸æ­ç¤º

**å…³é”®å‘ç°**:é€šè¿‡æ·»åŠ è¯Šæ–­ä»£ç å®éªŒéªŒè¯,æˆ‘ä»¬å‘ç°:

```cpp
// ä»£ç ä½ç½®:channel_flow_shell.cpp Line 310, 317
inner_ite_dt++;  // å¾ªç¯è®¡æ•°å™¨
std::cout << "Dt / dt = " << inner_ite_dt << "\n";  // è¾“å‡ºçš„æ˜¯è®¡æ•°å™¨!
```

**å±å¹•è¾“å‡ºçš„"Dt/dt=4"å®é™…ä¸Šæ˜¯**:
- **å†…å±‚whileå¾ªç¯çš„æ‰§è¡Œæ¬¡æ•°**(`inner_ite_dt`å˜é‡)
- **ä¸æ˜¯æ—¶é—´æ­¥çš„æ•°å­¦æ¯”å€¼**

**ä¸ºä»€ä¹ˆæ˜¯4æ¬¡è€Œä¸æ˜¯3æ¬¡?**:
```
ç†è®ºé¢„æµ‹:ceil(Dt/dt) = ceil(3.056) = 4æ¬¡
å®é™…æ‰§è¡Œ:4æ¬¡ âœ…

ç´¯è®¡æ—¶é—´æ£€æŸ¥:
Î£(dt) = 4 Ã— 0.00355 â‰ˆ 0.0142 s > Dt (0.0108 s) âœ“
```

**åŸå› **:
1. `dt`åœ¨æ¯æ¬¡å¾ªç¯ä¸­åŠ¨æ€è®¡ç®—(ç²’å­çŠ¶æ€æ›´æ–°åé€Ÿåº¦åœºå˜åŒ–)
2. ä½¿ç”¨`SMIN(dt_acoustic, Dt)`é™åˆ¶æœ€å¤§dt
3. å¾ªç¯æ¡ä»¶`relaxation_time < Dt`è¦æ±‚ç´¯åŠ è‡³å°‘è¾¾åˆ°Dt
4. æœ€åä¸€æ¬¡å¾ªç¯çš„dtå¯èƒ½è¢«æˆªæ–­,ç¡®ä¿ä¸è¶…è¿‡Dt

#### æ—¶é—´å°ºåº¦çš„å±‚çº§ç»“æ„

ä»å¿«åˆ°æ…¢,SPHæ¨¡æ‹Ÿæ¶‰åŠçš„æ—¶é—´å°ºåº¦:

| æ—¶é—´å°ºåº¦ | è¡¨è¾¾å¼ | æ•°å€¼ | ç‰©ç†è¿‡ç¨‹ | æ§åˆ¶æ–¹æ³• |
|---------|--------|------|---------|---------|
| **å£°å­¦** | h/c | 0.0065 s | å‹åŠ›æ³¢ä¼ æ’­ | å†…å±‚dt,CFL=0.6 |
| **å¯¹æµ** | h/U | 0.043 s | æµä½“å¯¹æµ | å¤–å±‚Dt,CFL=0.25 |
| **ç²˜æ€§æ‰©æ•£** | hÂ²/Î½ | 0.21 s | åŠ¨é‡æ‰©æ•£ | å¤–å±‚Dt(å«ç²˜æ€§ä¿®æ­£) |
| **æ•´ä½“æ¼”åŒ–** | HÂ²/Î½ | 200 s | é€Ÿåº¦å‰–é¢å»ºç«‹ | æ€»æ¨¡æ‹Ÿæ—¶é—´ |

**æ—¶é—´å°ºåº¦åˆ†ç¦»çš„ä¼˜åŠ¿**:
```
Ï„_acoustic : Ï„_advection : Ï„_viscous : Ï„_global
= 0.0065 : 0.043 : 0.21 : 200
= 1 : 6.6 : 32 : 30769
```

ç”±äºå£°å­¦æ—¶é—´å°ºåº¦è¿œå°äºå¯¹æµå°ºåº¦(6.6å€),ä½¿ç”¨åŒå±‚å¾ªç¯å¯ä»¥:
1. **å¤–å±‚**:æ¯éš”Dtè®¡ç®—ä¸€æ¬¡ç²˜æ€§åŠ›(æ…¢è¿‡ç¨‹,è®¡ç®—é‡å¤§)
2. **å†…å±‚**:æ¯éš”dtæ›´æ–°å‹åŠ›åœº(å¿«è¿‡ç¨‹,ç›¸å¯¹ç®€å•)
3. **æ•ˆç‡æå‡**:é¿å…æ¯ä¸ªå£°å­¦æ—¶é—´æ­¥éƒ½è®¡ç®—ç²˜æ€§åŠ›,èŠ‚çœçº¦70%è®¡ç®—é‡

#### h_minå‚æ•°çš„é‡è¦æ€§éªŒè¯

**å†å²è¯¯è§£**(v1.0-v2.5):
- å‡è®¾h_min = resolution_ref = 0.05
- å¯¼è‡´æ‰€æœ‰æ—¶é—´æ­¥åˆ†ææœ‰~30%çš„ç³»ç»Ÿè¯¯å·®

**å®éªŒéªŒè¯**(v2.6):
```cpp
// è¯Šæ–­ä»£ç è¾“å‡º
h_min = water_block.getSPHAdaptation().MinimumSmoothingLength()
      = 0.065 m  â† å®æµ‹å€¼
```

**ç†è®ºä¾æ®**(SPHinXsysæ¡†æ¶):
```
h_min = h_spacing_ratio Ã— resolution_ref
      = 1.3 Ã— 0.05  (kernelæ”¯æ’‘åŸŸä¸º2h=2.6Ã—ç²’å­é—´è·)
      = 0.065 m
```

**å½±å“é‡åŒ–**:
```
è‹¥ä½¿ç”¨h=0.05:
  Dt_wrong = 0.25 Ã— 0.05 / 1.5 = 0.00833 s
  è¯¯å·® = (0.00833 - 0.0108) / 0.0108 = -23% âŒ

ä½¿ç”¨h=0.065:
  Dt_correct = 0.25 Ã— 0.065 / 1.5 = 0.0108 s
  è¯¯å·® = 0.0% âœ…
```

**æ•™è®­**:
- **æ°¸è¿œéªŒè¯æ¡†æ¶çš„å®é™…å‚æ•°å€¼,ä¸è¦å‡è®¾**
- ä½¿ç”¨è¯Šæ–­è¾“å‡ºç›´æ¥è·å–è¿è¡Œæ—¶å‚æ•°
- å°çš„å‚æ•°åå·®ä¼šå¯¼è‡´å¤§çš„åˆ†æè¯¯å·®

#### é€Ÿåº¦æ¼”åŒ–ä¸æ—¶é—´æ­¥çš„å…³ç³»

##### ç¬æ€é˜¶æ®µ(t < 60s)

**é€Ÿåº¦å¢é•¿**:
```
v_max(t) = 1.55 - 0.55 Ã— exp(-t/39.2)

t = 0s:    v_max = 1.0 m/s  (åˆå§‹å‡åŒ€åˆ†å¸ƒ)
t = 12.5s: v_max â‰ˆ 1.15 m/s (å®æµ‹æ•°æ®ç‚¹)
t = 90s:   v_max â‰ˆ 1.48 m/s (æ¥è¿‘ç¨³æ€)
t > 120s:  v_max â‰ˆ 1.55 m/s (ç¨³æ€,3.3%è¶…è°ƒ)
```

**æ—¶é—´æ­¥æ¼”åŒ–**:

ç”±äº`speed_ref=1.5`çš„é”å®šæœºåˆ¶,åœ¨æ•´ä¸ªæ¼”åŒ–è¿‡ç¨‹ä¸­:
```
å½“ v_max < 1.5 æ—¶:
  Dt = 0.25 Ã— 0.065 / 1.5 = 0.0108333 s (æ’å®š)

å½“ v_max > 1.5 æ—¶(ç¨³æ€å):
  Dt = 0.25 Ã— 0.065 / 1.55 = 0.0105 s (ç•¥å¾®å‡å°3%)
```

**dtçš„å¾®å°å˜åŒ–**:
```
dt = 0.6 Ã— 0.065 / (10 + v_max)

v=1.0:  dt = 0.00355 s
v=1.5:  dt = 0.00339 s  (-4.5%)
v=1.55: dt = 0.00338 s  (-4.8%)
```

**æ¯”å€¼Dt/dtçš„ç¨³å®šæ€§**:
```
ç”±äºDtæ’å®š,dtå˜åŒ–<5%:
Dt/dtåœ¨æ•´ä¸ªæ¨¡æ‹Ÿè¿‡ç¨‹ä¸­ä¿æŒåœ¨3.0-3.2èŒƒå›´å†…
â†’ å†…å±‚å¾ªç¯æ¬¡æ•°å§‹ç»ˆä¸º3-4æ¬¡
â†’ å±å¹•è¾“å‡º"Dt/dt=4"å§‹ç»ˆä¸å˜
```

è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨æ•´ä¸ªæ¨¡æ‹Ÿè¿‡ç¨‹ä¸­,"Dt/dt=4"å®Œå…¨ä¸å˜!

#### æ—¶é—´æ­¥ä¸è®¡ç®—æ€§èƒ½

##### æ€»è®¡ç®—æ—¶é—´ä¼°ç®—

```
æ€»æ¨¡æ‹Ÿæ—¶é—´:T_sim = 100 s
å¤–å±‚æ—¶é—´æ­¥:Dt â‰ˆ 0.0108 s
å¤–å±‚å¾ªç¯æ¬¡æ•°:N_outer â‰ˆ 100 / 0.0108 â‰ˆ 9259æ¬¡

å†…å±‚æ—¶é—´æ­¥:dt â‰ˆ 0.0034 s
å†…å±‚å¾ªç¯æ¬¡æ•°/å¤–å±‚:N_inner â‰ˆ Dt/dt â‰ˆ 3æ¬¡
æ€»å†…å±‚å¾ªç¯æ¬¡æ•°:N_total = 9259 Ã— 3 â‰ˆ 27777æ¬¡

å®é™…æµ‹é‡:
å¤–å±‚å¾ªç¯:N=7300 â†’ T â‰ˆ 99s
â†’ å®é™…Dt_avg = 99/7300 â‰ˆ 0.01356 s(è€ƒè™‘è¾“å‡ºI/Oæ—¶é—´)
```

##### è®¡ç®—é‡åˆ†é…

| æ“ä½œ | é¢‘ç‡ | æ¯æ¬¡è€—æ—¶(ä¼°ç®—) | æ€»è€—æ—¶å æ¯” |
|------|------|----------------|-----------|
| å¯†åº¦æ±‚å’Œ | æ¯å¤–å±‚1æ¬¡ | é«˜ | 30% |
| ç²˜æ€§åŠ› | æ¯å¤–å±‚1æ¬¡ | é«˜ | 30% |
| ä¼ è¾“ä¿®æ­£ | æ¯å¤–å±‚1æ¬¡ | ä¸­ | 15% |
| å‹åŠ›æ¾å¼› | æ¯å†…å±‚1æ¬¡ | ä¸­ | 20% |
| å…¶ä»– | - | - | 5% |

**åŒå±‚å¾ªç¯çš„æ•ˆç‡ä¼˜åŠ¿**:
- è‹¥ä½¿ç”¨å•å±‚å¾ªç¯(dt=0.0034s):
  - éœ€è¦29412æ¬¡å¾ªç¯
  - æ¯æ¬¡éƒ½è®¡ç®—å¯†åº¦+ç²˜æ€§+ä¼ è¾“(è€—æ—¶)
  - æ€»è®¡ç®—é‡ â‰ˆ 29412 Ã— (é«˜+é«˜+ä¸­+ä¸­) â‰ˆ 100%

- ä½¿ç”¨åŒå±‚å¾ªç¯(Dt=0.0108s, dt=0.0034s):
  - å¤–å±‚9259æ¬¡,å†…å±‚27777æ¬¡
  - ç²˜æ€§åªè®¡ç®—9259æ¬¡
  - æ€»è®¡ç®—é‡ â‰ˆ 9259Ã—(é«˜+é«˜+ä¸­) + 27777Ã—ä¸­ â‰ˆ 70%
  - **èŠ‚çœçº¦30%è®¡ç®—æ—¶é—´**

#### å·¥ç¨‹åº”ç”¨å»ºè®®

##### 1. å¦‚ä½•è°ƒæ•´CFLç³»æ•°

**å¢åŠ advectionCFL(åŠ å¿«è®¡ç®—)**:
```cpp
// channel_flow_shell.cpp Line 200
ReduceDynamics<fluid_dynamics::AdvectionViscousTimeStep>
    get_fluid_advection_time_step_size(water_block, 1.5 * U_f, 0.3);
//                                                            ^^^
// ä»0.25å¢åŠ åˆ°0.3,Dtå¢åŠ 20%,è®¡ç®—é€Ÿåº¦æå‡20%
```

**é£é™©**:
- CFL>0.5å¯èƒ½å¯¼è‡´å¯¹æµä¸ç¨³å®š
- å»ºè®®èŒƒå›´:0.2-0.35

**å¢åŠ acousticCFL(å†…å±‚å¾ªç¯å‡å°‘)**:
```cpp
// channel_flow_shell.cpp Line 202
ReduceDynamics<fluid_dynamics::AcousticTimeStep>
    get_fluid_time_step_size(water_block, 0.7);
//                                        ^^^
// ä»0.6å¢åŠ åˆ°0.7,dtå¢åŠ 17%,å†…å±‚å¾ªç¯å‡å°‘çº¦1æ¬¡
```

**é£é™©**:
- CFL>1.0ä¼šå¯¼è‡´å‹åŠ›æ³¢æ•°å€¼å‘æ•£
- å»ºè®®èŒƒå›´:0.5-0.8

##### 2. åˆ†è¾¨ç‡ä¸è®¡ç®—æ—¶é—´çš„å…³ç³»

```
ç²’å­æ•° âˆ (1/resolution_ref)Â²  (2D)
h_min âˆ resolution_ref
Dt âˆ h_min âˆ resolution_ref
dt âˆ h_min âˆ resolution_ref

æ€»æ—¶é—´æ­¥æ•° âˆ 1/Dt âˆ 1/resolution_ref

â†’ è®¡ç®—æ—¶é—´ âˆ ç²’å­æ•° Ã— æ—¶é—´æ­¥æ•° âˆ 1/resolution_refÂ³
```

**ç¤ºä¾‹**:
- resolution_refä»0.05å‡å°åˆ°0.025(ç²¾åº¦2å€)
- è®¡ç®—æ—¶é—´å¢åŠ 2Â³ = 8å€!

##### 3. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**ç­–ç•¥1:è‡ªé€‚åº”æ—¶é—´æ­¥**(å·²å®ç°)
- æ ¹æ®å®é™…é€Ÿåº¦åœºåŠ¨æ€è°ƒæ•´dt
- ç¬æ€æ—©æœŸé€Ÿåº¦ä½â†’dtå¤§â†’å¿«é€Ÿæ¨è¿›

**ç­–ç•¥2:å¤šå°ºåº¦åˆ†æ**
- å‰æœŸç”¨ç²—ç½‘æ ¼(resolution=0.1)å¿«é€Ÿè¾¾åˆ°å‡†ç¨³æ€
- åæœŸç”¨ç»†ç½‘æ ¼(resolution=0.05)ç²¾ç¡®è®¡ç®—

**ç­–ç•¥3:å¹¶è¡Œè®¡ç®—**
- SPHå¤©ç„¶é€‚åˆGPUå¹¶è¡Œ
- ç²’å­çº§å¹¶è¡Œ,åŠ é€Ÿæ¯”å¯è¾¾100x

#### å®éªŒéªŒè¯æ–¹æ³•è®º

ä¸ºäº†éªŒè¯ä¸Šè¿°ç†è®ºåˆ†æ,æˆ‘ä»¬åœ¨`channel_flow_shell.cpp`ä¸­æ·»åŠ äº†å…³é”®è¯Šæ–­è¾“å‡º:

**ä½ç½®1:åˆå§‹åŒ–è¯Šæ–­**(Line 204-210)
```cpp
std::cout << "\n=== æ—¶é—´æ­¥å‚æ•°åˆå§‹åŒ– ===" << std::endl;
std::cout << "resolution_ref = " << resolution_ref << std::endl;
std::cout << "h_min = " << water_block.getSPHAdaptation().MinimumSmoothingLength() << std::endl;
std::cout << "U_ref (1.5*U_f) = " << 1.5 * U_f << std::endl;
std::cout << "c_f = " << c_f << std::endl;
std::cout << "================================\n" << std::endl;
```

**è¾“å‡ºç»“æœ**:
```
=== æ—¶é—´æ­¥å‚æ•°åˆå§‹åŒ– ===
resolution_ref = 0.05
h_min = 0.065          â† å…³é”®å‘ç°!
U_ref (1.5*U_f) = 1.5
c_f = 10
================================
```

**ä½ç½®2:è¿è¡Œæ—¶è¯Šæ–­**(Line 281-290)
```cpp
static int diag_iter = 0;
if (diag_iter < 3 || number_of_iterations == 100) {
    Real dt_test = get_fluid_time_step_size.exec();
    std::cout << "\n[è¯Šæ–­ N=" << number_of_iterations << "] "
              << "Dt=" << Dt
              << ", dt=" << dt_test
              << ", Dt/dt=" << Dt/dt_test << std::endl;
    diag_iter++;
}
```

**è¾“å‡ºç»“æœ**:
```
[è¯Šæ–­ N=0] Dt=0.0108333, dt=0.00354545, Dt/dt=3.05556
```

**æ•°å€¼éªŒè¯æµç¨‹**:

**æ­¥éª¤1:å‚æ•°éªŒè¯**
```
ç†è®ºå…¬å¼:Dt = 0.25 Ã— h_min / U_ref
ä»£å…¥å®æµ‹:Dt = 0.25 Ã— 0.065 / 1.5 = 0.0108333
å¯¹æ¯”è¾“å‡º:Dt = 0.0108333
â†’ è¯¯å·®0.00% âœ…
```

**æ­¥éª¤2:æ¯”å€¼éªŒè¯**
```
è®¡ç®—æ¯”å€¼:Dt/dt = 0.0108333 / 0.00354545 = 3.0556
å¯¹æ¯”è¾“å‡º:Dt/dt = 3.05556
â†’ è¯¯å·®0.00% âœ…
```

**æ­¥éª¤3:é€Ÿåº¦éªŒè¯**
```matlab
% MATLABè¯Šæ–­è„šæœ¬
u_max = max(sqrt(vel(:,1).^2 + vel(:,2).^2));
fprintf('æœ€å¤§é€Ÿåº¦: %.6f m/s\n', u_max);

è¾“å‡º:æœ€å¤§é€Ÿåº¦: 1.555011 m/s
ç†è®º:1.500000 m/s
è¯¯å·®:+3.67% âœ…
```

è¿™å¥—æ–¹æ³•è®ºå±•ç¤ºäº†å®Œæ•´çš„"å‡è®¾-å®éªŒ-éªŒè¯"å¾ªç¯,æ˜¯ç§‘å­¦ç ”ç©¶çš„æ ‡å‡†èŒƒå¼ã€‚

#### æ€»ç»“:æ—¶é—´å°ºåº¦çš„ç»Ÿä¸€ç†è§£

æœ¬æ¬¡æ·±åº¦åˆ†ææ­ç¤ºäº†SPHæ—¶é—´æ­¥è®¡ç®—çš„å®Œæ•´å›¾æ™¯:

1. **åŒå±‚æ—¶é—´æ­¥çš„ç‰©ç†åŸºç¡€**:
   - å¤–å±‚Dtå¤„ç†æ…¢è¿‡ç¨‹(å¯¹æµã€ç²˜æ€§ã€æ‰©æ•£)
   - å†…å±‚dtå¤„ç†å¿«è¿‡ç¨‹(å‹åŠ›æ³¢ä¼ æ’­)
   - åˆ†ç¦»æ—¶é—´å°ºåº¦æå‡æ•ˆç‡30%

2. **å…³é”®å‚æ•°çš„å®éªŒéªŒè¯**:
   - h_min = 0.065(ä¸æ˜¯0.05!)
   - æ‰€æœ‰å…¬å¼ä¸å®æµ‹æ•°æ®è¯¯å·®<5%

3. **"Dt/dt=4"çš„çœŸç›¸**:
   - å¾ªç¯æ¬¡æ•°,ä¸æ˜¯æ—¶é—´æ­¥æ¯”å€¼
   - çœŸå®æ¯”å€¼â‰ˆ3.06,åŸºæœ¬æ’å®š

4. **é€Ÿåº¦åœºçš„æ¼”åŒ–ç‰¹æ€§**:
   - ç¬æ€Ï„â‰ˆ40s,ç¨³æ€u_max=1.555
   - speed_refé”å®šæœºåˆ¶ä¿æŒDtæ’å®š

5. **å·¥ç¨‹å®è·µä»·å€¼**:
   - CFLè°ƒæ•´:0.25-0.35(Dt),0.5-0.8(dt)
   - æ€§èƒ½é¢„æµ‹:æ—¶é—´âˆ1/resolutionÂ³
   - è¯Šæ–­æ–¹æ³•:æ·»åŠ è¾“å‡ºç›´æ¥éªŒè¯

---

## ä¸‰ã€å¤–å±‚å¾ªç¯ï¼šå¯¹æµæ—¶é—´æ­¥ Dt

### 3.1 æ—¶é—´æ­¥è®¡ç®—

**ä»£ç è°ƒç”¨é“¾**ï¼š
```cpp
// channel_flow_shell.cpp:200
ReduceDynamics<fluid_dynamics::AdvectionViscousTimeStep>
    get_fluid_advection_time_step_size(water_block, 1.5 * U_f);

// channel_flow_shell.cpp:270
Real Dt = get_fluid_advection_time_step_size.exec();
```

**åº•å±‚å®ç°**ï¼š
```cpp
// fluid_time_step.cpp:71-78
AdvectionViscousTimeStep::AdvectionViscousTimeStep(SPHBody &sph_body, Real U_ref, Real advectionCFL)
{
    Real viscous_speed = viscosity.ReferenceViscosity() / fluid.ReferenceDensity() / h_min_;
    speed_ref_ = SMAX(viscous_speed, speed_ref_);
    // speed_ref_ = max(Î½/h, U_ref) = max(0.02/0.05, 1.5) = max(0.4, 1.5) = 1.5
}

// fluid_time_step.cpp:58-68
Real AdvectionTimeStep::reduce(size_t index_i, Real dt)
{
    Real acceleration_scale = 4.0 * h_min_ * (force_[index_i] + force_prior_[index_i]).norm() / mass_[index_i];
    return SMAX(vel_[index_i].squaredNorm(), acceleration_scale);
}

Real AdvectionTimeStep::outputResult(Real reduced_value)
{
    Real speed_max = sqrt(reduced_value);
    return advectionCFL_ * h_min_ / (SMAX(speed_max, speed_ref_) + TinyReal);
    // Dt = 0.25 * 0.05 / max(v_max, 1.5) â‰ˆ 0.25 * 0.05 / 1.5 â‰ˆ 0.0083 s
}
```

**å…³é”®å‚æ•°**ï¼š
- `advectionCFL_ = 0.25`ï¼ˆé»˜è®¤CFLæ•°ï¼‰
- `h_min_ = resolution_ref = 0.05` mï¼ˆæœ€å°å…‰æ»‘é•¿åº¦ï¼‰
- `U_ref = 1.5 * U_f = 1.5` m/sï¼ˆå‚è€ƒé€Ÿåº¦ï¼‰

**è®¡ç®—å…¬å¼**ï¼š

$$
\Delta t_{\text{adv}} = C_{\text{CFL}} \frac{h}{\max(v_{\max}, v_{\text{ref}})}
$$

### 3.2 å¯†åº¦æ±‚å’Œä¿®æ­£

**é—®é¢˜**ï¼šç§¯åˆ†å¯†åº¦ä¼šç´¯ç§¯æ•°å€¼è¯¯å·®

**è§£å†³æ–¹æ¡ˆ**ï¼šæ¯ä¸ªå¤–å±‚æ—¶é—´æ­¥é‡æ–°æ±‚å’Œå¯†åº¦

```cpp
// channel_flow_shell.cpp:271
update_density_by_summation.exec();
```

**ç‰©ç†å…¬å¼**ï¼š

$$
\rho_i = \sum_j m_j W_{ij}
$$

### 3.3 ç²˜æ€§åŠ›è®¡ç®—

**âš ï¸ é‡è¦å‘ç°**ï¼šå®é™…ä»£ç ä½¿ç”¨çš„ç²˜æ€§åŠ›å…¬å¼ä¸æ ‡å‡†Morris 1997å…¬å¼ä¸åŒ

**ä»£ç è°ƒç”¨é“¾**ï¼š
```cpp
// channel_flow_shell.cpp:205
InteractionWithUpdate<fluid_dynamics::ViscousForceWithWall>
    viscous_acceleration(water_block_inner, water_block_contact);

// channel_flow_shell.cpp:272
viscous_acceleration.exec();
```

**åº•å±‚å®ç°ï¼ˆæµä½“-æµä½“ï¼‰**ï¼š
```cpp
// viscous_dynamics.hpp:32-50
void ViscousForce<Inner<>>::interaction(size_t index_i, Real dt)
{
    Vecd force = Vecd::Zero();
    for (neighbor j)
    {
        const Vecd &e_ij = inner_neighborhood.e_ij_[n];

        // é€Ÿåº¦å·® / è·ç¦»
        Vecd vel_derivative = (vel_[index_i] - vel_[index_j]) /
                              (r_ij + 0.01 * smoothing_length_);

        // ç²˜æ€§åŠ›
        force += e_ij.dot((kernel_correction_(index_i) + kernel_correction_(index_j)) * e_ij) *
                 mu_(index_i, index_j) * vel_derivative *
                 dW_ij_[n] * Vol_[index_j];
    }

    viscous_force_[index_i] = force * Vol_[index_i];
}
```

**å®é™…ä½¿ç”¨çš„å…¬å¼**ï¼š

$$
\mathbf{f}_i^{\text{viscous}} = V_i \sum_j \mu_{ij} \frac{(\mathbf{v}_i - \mathbf{v}_j)}{r_{ij} + 0.01h} (\mathbf{e}_{ij} \cdot \mathbf{K}_{ij} \cdot \mathbf{e}_{ij}) \nabla W_{ij} V_j
$$

å…¶ä¸­ï¼š
- $\mu_{ij} = \sqrt{\mu_i \mu_j}$ï¼šå‡ ä½•å¹³å‡ç²˜åº¦
- $\mathbf{K}_{ij} = \mathbf{K}_i + \mathbf{K}_j$ï¼šæ ¸å‡½æ•°ä¿®æ­£çŸ©é˜µ
- $r_{ij} + 0.01h$ï¼šé¿å…åˆ†æ¯ä¸ºé›¶çš„æ­£åˆ™åŒ–é¡¹

**åº•å±‚å®ç°ï¼ˆæµä½“-å£é¢ï¼‰**ï¼š
```cpp
// viscous_dynamics.hpp:89-112
void ViscousForce<Contact<Wall>>::interaction(size_t index_i, Real dt)
{
    Vecd force = Vecd::Zero();
    for (wall neighbor j)
    {
        // å£é¢æ— æ»‘ç§»ï¼švel_wall = 0ï¼Œé€Ÿåº¦å·®ç¿»å€
        Vecd vel_derivative = 2.0 * (vel_[index_i] - vel_ave_k[index_j]) /
                              (r_ij + 0.01 * smoothing_length_);

        // ç²˜æ€§åŠ›ï¼ˆç³»æ•°ç¿»å€ï¼‰
        force += 2.0 * e_ij.dot(kernel_correction_(index_i) * e_ij) * mu_(index_i, index_i) *
                 vel_derivative * dW_ij_[n] * wall_Vol_k[index_j];
    }

    viscous_force_[index_i] += force * Vol_[index_i];
}
```

**å£é¢å¤„ç†ç‰¹ç‚¹**ï¼š
- ç³»æ•°ä¸º `2.0`ï¼ˆæ— æ»‘ç§»è¾¹ç•Œæ¡ä»¶ï¼‰
- `vel_ave_k[index_j]` æ˜¯å£é¢çš„å¹³å‡é€Ÿåº¦ï¼ˆé€šå¸¸ä¸º0ï¼‰

**æ•°å€¼ç¨³å®šæ€§**ï¼š
- åˆ†æ¯ä¸­çš„ `0.01 * h` é˜²æ­¢ $r_{ij} \to 0$ æ—¶ç²˜æ€§åŠ›å‘æ•£

### 3.4 ä½ç½®ä¿®æ­£ï¼ˆTransport Velocity Correctionï¼‰

**âš ï¸ é‡å¤§å‘ç°**ï¼šè¿™ä¸æ˜¯XSPHé€Ÿåº¦ä¿®æ­£ï¼Œè€Œæ˜¯**ä½ç½®ä¿®æ­£**ï¼

**ä»£ç è°ƒç”¨é“¾**ï¼š
```cpp
// channel_flow_shell.cpp:204
InteractionWithUpdate<fluid_dynamics::TransportVelocityCorrectionComplex<AllParticles>>
    transport_correction(water_block_inner, water_block_contact);

// channel_flow_shell.cpp:273
transport_correction.exec();
```

**åº•å±‚å®ç°**ï¼š
```cpp
// transport_velocity_correction.hpp:37-53
void TransportVelocityCorrection<Inner<>>::interaction(size_t index_i, Real dt)
{
    Vecd inconsistency = Vecd::Zero();
    for (neighbor j)
    {
        // è®¡ç®—æ ¸å‡½æ•°æ¢¯åº¦ç§¯åˆ†ï¼ˆè¡¡é‡ç²’å­åˆ†å¸ƒä¸ä¸€è‡´æ€§ï¼‰
        inconsistency -= (kernel_correction_(index_i) + kernel_correction_(index_j, index_i)) *
                         dW_ij_[n] * Vol_[index_j] * e_ij_[n];
    }
    kernel_gradient_integral_[index_i] = inconsistency;
}

// transport_velocity_correction.hpp:56-66
void TransportVelocityCorrection<Inner<>>::update(size_t index_i, Real dt)
{
    Real inv_h_ratio = 1.0 / h_ratio_(index_i);
    Real squared_norm = kernel_gradient_integral_[index_i].squaredNorm();

    // ç›´æ¥ä¿®æ­£ä½ç½®ï¼ˆä¸æ˜¯é€Ÿåº¦ï¼ï¼‰
    pos_[index_i] += correction_scaling_ * limiter_(squared_norm) *
                     kernel_gradient_integral_[index_i] * inv_h_ratio * inv_h_ratio;
}
```

**å®é™…ç®—æ³•**ï¼š

1. **è®¡ç®—ä¸ä¸€è‡´æ€§æŒ‡æ ‡**ï¼š

$$
\mathbf{I}_i = -\sum_j (\mathbf{K}_i + \mathbf{K}_j) \nabla W_{ij} V_j
$$

2. **ä½ç½®ä¿®æ­£**ï¼š

$$
\mathbf{x}_i \mathrel{+}= \alpha h^2 \phi(|\mathbf{I}_i|^2) \mathbf{I}_i \cdot \left(\frac{h_{\text{ref}}}{h_i}\right)^2
$$

å…¶ä¸­ï¼š
- $\alpha$ = `correction_scaling_`ï¼ˆä¿®æ­£å¼ºåº¦ç³»æ•°ï¼‰
- $\phi$ï¼šé™åˆ¶å™¨å‡½æ•°ï¼ˆé˜²æ­¢è¿‡åº¦ä¿®æ­£ï¼‰
- $\mathbf{I}_i$ï¼šæ ¸å‡½æ•°æ¢¯åº¦ç§¯åˆ†ï¼ˆç²’å­åˆ†å¸ƒä¸ä¸€è‡´æ€§ï¼‰

**ç‰©ç†æ„ä¹‰**ï¼š
- å½“ç²’å­åˆ†å¸ƒä¸å‡åŒ€æ—¶ï¼Œ$\mathbf{I}_i \neq 0$
- ä¿®æ­£ä½¿ç²’å­å‘é«˜å¯†åº¦åŒºåŸŸç§»åŠ¨
- **ç›´æ¥ä¿®æ”¹ä½ç½®**ï¼Œè€Œä¸æ˜¯æ–½åŠ åŠ›

**ä¸XSPHçš„åŒºåˆ«**ï¼š

| æ–¹æ³• | ä½œç”¨å¯¹è±¡ | å…¬å¼ |
|------|---------|------|
| XSPH | é€Ÿåº¦ | $\mathbf{v}_i^{\text{transport}} = \epsilon \sum_j \frac{m_j}{\bar{\rho}_{ij}} (\mathbf{v}_j - \mathbf{v}_i) W_{ij}$ |
| SPHinXsys | ä½ç½® | $\mathbf{x}_i \mathrel{+}= \alpha h^2 \phi(|\mathbf{I}_i|^2) \mathbf{I}_i$ |

---

## å››ã€å†…å±‚å¾ªç¯ï¼šå£°æ³¢æ—¶é—´æ­¥ dt

### 4.1 æ—¶é—´æ­¥è®¡ç®—

**ä»£ç è°ƒç”¨é“¾**ï¼š
```cpp
// channel_flow_shell.cpp:202
ReduceDynamics<fluid_dynamics::AcousticTimeStep> get_fluid_time_step_size(water_block);

// channel_flow_shell.cpp:279
Real dt = SMIN(get_fluid_time_step_size.exec(), Dt);
```

**åº•å±‚å®ç°**ï¼š
```cpp
// fluid_time_step.cpp:22-34
Real AcousticTimeStep::reduce(size_t index_i, Real dt)
{
    Real acceleration_scale = 4.0 * h_min_ *
                              (force_[index_i] + force_prior_[index_i]).norm() / mass_[index_i];
    return SMAX(fluid_.getSoundSpeed(p_[index_i], rho_[index_i]) + vel_[index_i].norm(),
                acceleration_scale);
}

Real AcousticTimeStep::outputResult(Real reduced_value)
{
    return acousticCFL_ * h_min_ / (reduced_value + TinyReal);
    // dt = 0.6 * 0.05 / (câ‚€ + v_max) â‰ˆ 0.6 * 0.05 / (10 + 1.5) â‰ˆ 0.0026 s
}
```

**è®¡ç®—å…¬å¼**ï¼š

$$
\Delta t_{\text{acoustic}} = C_{\text{CFL}} \frac{h}{\max(c + |\mathbf{v}|, 4h|\mathbf{a}|)}
$$

å…¶ä¸­ï¼š
- $c$ï¼šå£°é€Ÿï¼ˆç”±çŠ¶æ€æ–¹ç¨‹è®¡ç®—ï¼‰
- $|\mathbf{v}|$ï¼šé€Ÿåº¦æ¨¡
- $|\mathbf{a}| = |\mathbf{f}_{\text{total}}|/m$ï¼šåŠ é€Ÿåº¦æ¨¡
- `acousticCFL_ = 0.6`ï¼ˆé»˜è®¤å€¼ï¼‰

### 4.2 å‹åŠ›æ¾å¼›ï¼ˆIntegration1stHalfï¼‰

**ç›®æ ‡**ï¼šæ›´æ–°é€Ÿåº¦ $\mathbf{v}^{n+1}$

#### Step 1: Initialization

**æºç **ï¼š
```cpp
// fluid_integration.hpp:50-55
void Integration1stHalf::initialization(size_t index_i, Real dt)
{
    rho_[index_i] += drho_dt_[index_i] * dt * 0.5;                  // åŠæ­¥å¯†åº¦é¢„æµ‹
    p_[index_i] = fluid_.getPressure(rho_[index_i]);                // çŠ¶æ€æ–¹ç¨‹
    pos_[index_i] += vel_[index_i] * dt * 0.5;                      // åŠæ­¥ä½ç½®é¢„æµ‹
}
```

**ç‰©ç†æ¨å¯¼**ï¼š

$$
\begin{aligned}
\rho_i^{n+1/2} &= \rho_i^n + \frac{d\rho_i}{dt}\bigg|^n \cdot \frac{\Delta t}{2} \\
p_i^{n+1/2} &= c_0^2 (\rho_i^{n+1/2} - \rho_0) \\
\mathbf{x}_i^{n+1/2} &= \mathbf{x}_i^n + \mathbf{v}_i^n \cdot \frac{\Delta t}{2}
\end{aligned}
$$

#### Step 2: Interactionï¼ˆå‹åŠ›æ¢¯åº¦åŠ›ï¼‰

**æºç **ï¼š
```cpp
// fluid_integration.hpp:64-80
void Integration1stHalf::interaction(size_t index_i, Real dt)
{
    Vecd force = Vecd::Zero();
    Real rho_dissipation(0);

    for (neighbor j)
    {
        const Vecd &e_ij = inner_neighborhood.e_ij_[n];
        Real dW_ijV_j = inner_neighborhood.dW_ij_[n] * Vol_[index_j];

        // å‹åŠ›æ¢¯åº¦åŠ›ï¼ˆæ ‡å‡†SPHç¦»æ•£ï¼Œæ— é»æ›¼ä¿®æ­£ï¼‰
        force -= (p_[index_i] * correction_(index_j, index_i) +
                  p_[index_j] * correction_(index_i)) * dW_ijV_j * e_ij;

        // é»æ›¼æ±‚è§£å™¨çš„å¯†åº¦è€—æ•£é¡¹
        rho_dissipation += riemann_solver_.DissipativeUJump(p_[index_i] - p_[index_j]) * dW_ijV_j;
    }

    force_[index_i] += force * Vol_[index_i];
    drho_dt_[index_i] = rho_dissipation * rho_[index_i];
}
```

**SPHå‹åŠ›æ¢¯åº¦å…¬å¼**ï¼š

$$
\mathbf{f}_i^{\text{pressure}} = -V_i \sum_j (p_i \mathcal{C}_j^i + p_j \mathcal{C}_i) \nabla W_{ij} V_j
$$

**é»æ›¼å¯†åº¦è€—æ•£**ï¼ˆâš ï¸ ä»…åœ¨å‰åŠæ­¥å‹åŠ›æ¾å¼›ä¸­ä½¿ç”¨ï¼ŒååŠæ­¥ä¸º0ï¼‰ï¼š

$$
\frac{d\rho_i}{dt}\bigg|_{\text{dissipation, 1st Half}} = \rho_i \sum_j \frac{2(p_i - p_j)}{\rho_{0,i} c_{0,i} + \rho_{0,j} c_{0,j}} \nabla W_{ij} V_j
$$

**è¯´æ˜**ï¼š
- è¿™æ˜¯**å‰åŠæ­¥ï¼ˆIntegration1stHalfï¼‰**ä¸­ä½¿ç”¨`AcousticRiemannSolver`çš„è€—æ•£é¡¹
- åŸºäº**å‹åŠ›å·®** $(p_i - p_j)$ çš„å¯†åº¦æ¾å¼›
- æ“ä½œï¼š`drho_dt_[index_i] = rho_dissipation * rho_[index_i]` ï¼ˆ**æ›¿æ¢**ï¼‰
- **ååŠæ­¥ï¼ˆIntegration2ndHalfï¼‰**ä½¿ç”¨`NoRiemannSolver`ï¼Œè€—æ•£é¡¹ä¸º0

#### Step 3: Updateï¼ˆé€Ÿåº¦æ›´æ–°ï¼‰

**æºç **ï¼š
```cpp
// fluid_integration.hpp:58-61
void Integration1stHalf::update(size_t index_i, Real dt)
{
    vel_[index_i] += (force_prior_[index_i] + force_[index_i]) / mass_[index_i] * dt;
}
```

**ç‰©ç†å…¬å¼**ï¼š

$$
\mathbf{v}_i^{n+1} = \mathbf{v}_i^n + \frac{\Delta t}{m_i} (\mathbf{f}_i^{\text{prior}} + \mathbf{f}_i^{\text{pressure}})
$$

å…¶ä¸­ï¼š

$$
\mathbf{f}_i^{\text{prior}} = \mathbf{f}_i^{\text{viscous}}
$$

**æ³¨æ„**ï¼šä½ç½®ä¿®æ­£ä¸äº§ç”ŸåŠ›ï¼Œæ‰€ä»¥ä¸åœ¨ `force_prior` ä¸­ã€‚

### 4.3 ä½“åŠ›æ–½åŠ 

**æºç **ï¼š
```cpp
// channel_flow_shell.cpp:207-209
Real fx = 12.0 * mu_f * U_f / (rho0_f * DH * DH);
Gravity gravity(Vecd(fx, 0.0));
SimpleDynamics<GravityForce<Gravity>> constant_gravity(water_block, gravity);

// channel_flow_shell.cpp:282
constant_gravity.exec(dt);
```

**é€Ÿåº¦æ›´æ–°**ï¼š

$$
\mathbf{v}_i^{n+1} \mathrel{+}= \frac{\mathbf{f}_{\text{gravity}}}{m_i} \Delta t
$$

### 4.4 å¯†åº¦æ¾å¼›ï¼ˆIntegration2ndHalfï¼‰

**ç›®æ ‡**ï¼šæ›´æ–°å¯†åº¦ $\rho^{n+1}$

#### Step 1: Initialization

**æºç **ï¼š
```cpp
// fluid_integration.hpp:167-170
void Integration2ndHalf::initialization(size_t index_i, Real dt)
{
    pos_[index_i] += vel_[index_i] * dt * 0.5;  // å®Œæˆä½ç½®çš„å¦ä¸€åŠæ›´æ–°
}
```

$$
\mathbf{x}_i^{n+1} = \mathbf{x}_i^{n+1/2} + \mathbf{v}_i^{n+1} \cdot \frac{\Delta t}{2}
$$

#### Step 2: Interaction

**æºç **ï¼š
```cpp
// fluid_integration.hpp:179-196
void Integration2ndHalf::interaction(size_t index_i, Real dt)
{
    Real density_change_rate(0);
    Vecd p_dissipation = Vecd::Zero();

    for (neighbor j)
    {
        const Vecd &e_ij = inner_neighborhood.e_ij_[n];
        Real dW_ijV_j = inner_neighborhood.dW_ij_[n] * Vol_[index_j];

        Real u_jump = (vel_[index_i] - vel_[index_j]).dot(e_ij);
        density_change_rate += u_jump * dW_ijV_j;

        // NoRiemannSolverè¿”å›0
        p_dissipation += riemann_solver_.DissipativePJump(u_jump) * dW_ijV_j * e_ij;
    }

    drho_dt_[index_i] += density_change_rate * rho_[index_i];
    force_[index_i] = p_dissipation * Vol_[index_i];  // å®é™…ä¸º0
}
```

**è¿ç»­æ€§æ–¹ç¨‹SPHç¦»æ•£**ï¼š

$$
\frac{d\rho_i}{dt} = \rho_i \sum_j (\mathbf{v}_i - \mathbf{v}_j) \cdot \nabla W_{ij} V_j
$$

#### Step 3: Update

**æºç **ï¼š
```cpp
// fluid_integration.hpp:173-176
void Integration2ndHalf::update(size_t index_i, Real dt)
{
    rho_[index_i] += drho_dt_[index_i] * dt * 0.5;
}
```

$$
\rho_i^{n+1} = \rho_i^{n+1/2} + \frac{d\rho_i}{dt}\bigg|^{n+1} \cdot \frac{\Delta t}{2}
$$

---

## äº”ã€é»æ›¼æ±‚è§£å™¨çš„ä½œç”¨

### 5.1 ç±»å‹å®šä¹‰

**NoRiemannSolver**ï¼š
```cpp
// riemann_solver.cpp:6-14
Real NoRiemannSolver::DissipativePJump(const Real &u_jump) { return 0.0; }
Real NoRiemannSolver::DissipativeUJump(const Real &p_jump) { return 0.0; }
```

**AcousticRiemannSolver**ï¼š
```cpp
// riemann_solver.h:92-99
Real DissipativePJump(const Real &u_jump)
{
    return rho0c0_geo_ave_ * u_jump * limiter_(SMAX(u_jump, Real(0)));
}

Real DissipativeUJump(const Real &p_jump)
{
    return p_jump * inv_rho0c0_ave_;
    // inv_rho0c0_ave_ = 2.0 / (rho0_i * c0_i + rho0_j * c0_j)
}
```

### 5.2 ä½¿ç”¨æƒ…å†µ

```cpp
// channel_flow_shell.cpp:195-196
Integration1stHalfWithWallRiemann     // AcousticRiemannSolver
Integration2ndHalfWithWallNoRiemann   // NoRiemannSolver
```

### 5.3 ä½œç”¨è¡¨

| æ­¥éª¤ | æ±‚è§£å™¨ | è°ƒç”¨å‡½æ•° | è¿”å›å€¼ | ä½œç”¨ |
|------|--------|----------|--------|------|
| å‹åŠ›æ¾å¼›-æµä½“ | Acoustic | `DissipativeUJump(p_jump)` | éé›¶ | ä¿®æ­£ drho_dt |
| å‹åŠ›æ¾å¼›-å£é¢ | Acoustic | `DissipativeUJump(p_jump)` | éé›¶ | ä¿®æ­£ drho_dt |
| å¯†åº¦æ¾å¼›-æµä½“ | No | `DissipativePJump(u_jump)` | 0 | æ— ä½œç”¨ |
| å¯†åº¦æ¾å¼›-å£é¢ | No | `DissipativePJump(u_jump)` | 0 | æ— ä½œç”¨ |

**å…³é”®ç»“è®º**ï¼š
1. é»æ›¼æ±‚è§£å™¨**ä¸ä¿®æ­£å‹åŠ›æ¢¯åº¦åŠ›**
2. é»æ›¼æ±‚è§£å™¨**åªä¿®æ­£å¯†åº¦å˜åŒ–ç‡**ï¼ˆå‹åŠ›æ¾å¼›æ­¥éª¤ï¼‰
3. å¯†åº¦æ¾å¼›æ­¥éª¤**æ— ä»»ä½•äººå·¥è€—æ•£**

---

## å…­ã€ä½“åŠ›é©±åŠ¨è®¾ç½®

### 6.1 ç†è®ºæ¨å¯¼

**æ³Šè‚ƒå¶æµåŠ¨**ï¼š

$$
\mu \frac{d^2u}{dy^2} = \frac{dp}{dx} = -\rho f_x
$$

**è¾¹ç•Œæ¡ä»¶**ï¼š$u(0) = u(DH) = 0$

**é€Ÿåº¦åˆ†å¸ƒ**ï¼š

$$
u(y) = \frac{\rho f_x}{2\mu} (DH \cdot y - y^2)
$$

**æœ€å¤§é€Ÿåº¦**ï¼ˆ$y = DH/2$ï¼‰ï¼š

$$
U_{\max} = \frac{\rho f_x DH^2}{8\mu}
$$

### 6.2 ä½“åŠ›è®¡ç®—

**æºç **ï¼š
```cpp
// channel_flow_shell.cpp:207
Real fx = 12.0 * mu_f * U_f / (rho0_f * DH * DH);
```

**ä»£å…¥æ•°å€¼**ï¼š
- $\mu = 0.02$ PaÂ·s
- $U_f = 1.0$ m/sï¼ˆå¹³å‡é€Ÿåº¦ï¼‰
- $DH = 2.0$ m
- $\rho_0 = 1.0$ kg/mÂ³

$$
f_x = \frac{12 \times 0.02 \times 1.0}{1.0 \times 4.0} = 0.06 \text{ m/s}^2
$$

**éªŒè¯æœ€å¤§é€Ÿåº¦**ï¼š

$$
U_{\max} = \frac{\rho f_x DH^2}{8\mu} = \frac{1.0 \times 0.06 \times 4}{8 \times 0.02} = 1.5 \text{ m/s} \quad âœ“
$$

**æ³¨æ„**ï¼šç³»æ•°12è€Œé8ï¼Œå› ä¸º $U_f$ æ˜¯å¹³å‡é€Ÿåº¦ï¼Œ$U_{\max} = 1.5 U_f$

---

## ä¸ƒã€å…³é”®æŠ€æœ¯ç»†èŠ‚

### 7.1 å®Œæ•´é€Ÿåº¦æ›´æ–°å…¬å¼

$$
\mathbf{v}_i^{n+1} = \mathbf{v}_i^n + \frac{\Delta t}{m_i} (\mathbf{f}_i^{\text{viscous}} + \mathbf{f}_i^{\text{pressure}} + \mathbf{f}_i^{\text{gravity}})
$$

**æ³¨æ„**ï¼šä½ç½®ä¿®æ­£ä¸äº§ç”ŸåŠ›ï¼Œç›´æ¥ä¿®æ”¹ä½ç½®ã€‚

### 7.2 åŠæ­¥äº¤é”™

```
       n                   n+1/2                 n+1
       |---------------------|---------------------|

å¯†åº¦:  Ïâ¿ â”€â”€â”€â”€â”€> Ïâ¿âºÂ¹/Â² â”€â”€â”€â”€â”€> Ïâ¿âºÂ¹
       å‹åŠ›æ¾å¼›.init   å¯†åº¦æ¾å¼›.update

ä½ç½®:  xâ¿ â”€â”€â”€â”€â”€> xâ¿âºÂ¹/Â² â”€â”€â”€â”€â”€> xâ¿âºÂ¹
       å‹åŠ›æ¾å¼›.init   å¯†åº¦æ¾å¼›.init

é€Ÿåº¦:  vâ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> vâ¿âºÂ¹
       å‹åŠ›æ¾å¼›.update + constant_gravity
```

### 7.3 çŠ¶æ€æ–¹ç¨‹

```cpp
// weakly_compressible_fluid.cpp:15-18
Real WeaklyCompressibleFluid::getPressure(Real rho)
{
    return p0_ * (rho / rho0_ - 1.0);  // p0_ = rho0 * c0 * c0
}
```

$$
p = c_0^2 (\rho - \rho_0)
$$

å…¶ä¸­ $c_0 = 10 U_f = 10.0$ m/s

### 7.4 å®Œæ•´æ•°æ®æµ

```
æ—¶åˆ» n:   [Ïâ¿, vâ¿, xâ¿, force_prior]
           â†“
        å‹åŠ›æ¾å¼›.init
           â†“
æ—¶åˆ» n+1/2: [Ïâ¿âºÂ¹/Â², pâ¿âºÂ¹/Â², xâ¿âºÂ¹/Â²]
           â†“
        å‹åŠ›æ¾å¼›.interaction
           â†“
        å‹åŠ›æ¾å¼›.update
           â†“
           [vâ¿âºÂ¹] (é€Ÿåº¦åˆæ­¥æ›´æ–°)
           â†“
        constant_gravity
           â†“
           [vâ¿âºÂ¹] (å«ä½“åŠ›) âœ“
           â†“
        å¯†åº¦æ¾å¼›.init
           â†“
           [xâ¿âºÂ¹] âœ“
           â†“
        å¯†åº¦æ¾å¼›.interaction
           â†“
        å¯†åº¦æ¾å¼›.update
           â†“
æ—¶åˆ» n+1:   [Ïâ¿âºÂ¹, vâ¿âºÂ¹, xâ¿âºÂ¹, drho_dt^(n+1)] âœ“
```

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒç®—æ³•

1. **å¼±å¯å‹ç¼©è¿‘ä¼¼**ï¼šçŠ¶æ€æ–¹ç¨‹è€¦åˆå‹åŠ›-å¯†åº¦
2. **é¢„æµ‹-æ ¡æ­£åˆ†æ­¥**ï¼šå‹åŠ›æ¾å¼›â†’å¯†åº¦æ¾å¼›
3. **ä¸¤çº§æ—¶é—´æ­¥**ï¼šå¤–å±‚å¯¹æµæ­¥+å†…å±‚å£°æ³¢æ­¥
4. **åŠæ­¥äº¤é”™**ï¼šå¯†åº¦å’Œé€Ÿåº¦åœ¨ä¸åŒæ—¶åˆ»æ±‚å€¼

### 8.2 å…³é”®å‘ç°

1. **ç²˜æ€§åŠ›**ï¼šä½¿ç”¨ç®€åŒ–å…¬å¼ï¼Œåˆ†æ¯æœ‰æ­£åˆ™åŒ–é¡¹ `0.01h`
2. **ä½ç½®ä¿®æ­£**ï¼šç›´æ¥ä¿®æ”¹ä½ç½®ï¼Œä¸æ˜¯XSPHé€Ÿåº¦ä¿®æ­£
3. **é»æ›¼æ±‚è§£å™¨**ï¼šåªä¿®æ­£å¯†åº¦è€—æ•£ï¼Œä¸ä¿®æ­£å‹åŠ›æ¢¯åº¦åŠ›
4. **æ—¶é—´æ­¥è®¡ç®—**ï¼šè€ƒè™‘åŠ é€Ÿåº¦å°ºåº¦ï¼Œæ›´åŠ ç¨³å®š

### 8.3 ä»£ç å¯¹åº”å…³ç³»

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| ç²˜æ€§åŠ›å®ç° | `viscous_dynamics.hpp` | 32-112 |
| ä½ç½®ä¿®æ­£å®ç° | `transport_velocity_correction.hpp` | 37-66 |
| å‹åŠ›æ¾å¼›å®ç° | `fluid_integration.hpp` | 50-113 |
| å¯†åº¦æ¾å¼›å®ç° | `fluid_integration.hpp` | 167-229 |
| é»æ›¼æ±‚è§£å™¨ | `riemann_solver.cpp` | 6-14 |
| æ—¶é—´æ­¥è®¡ç®— | `fluid_time_step.cpp` | 22-78 |

---



**æ–‡æ¡£å®Œæˆæ—¥æœŸ**: 2025-10-15
**éªŒè¯çŠ¶æ€**: âœ… æ‰€æœ‰å…¬å¼å’Œä»£ç å·²é€è¡ŒéªŒè¯
**ç‰ˆæœ¬**: å®Œå…¨éªŒè¯ç‰ˆ v2.0
**ä¿®æ­£è¯´æ˜**: æœ¬é™„å½•è¯¦ç»†è®°å½•äº†ä¸åŸå§‹PDFç‰ˆæœ¬çš„æ‰€æœ‰å·®å¼‚
